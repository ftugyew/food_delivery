<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tindo ‚Äì Restaurant Menu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/ui.css">
  <link rel="stylesheet" href="css/responsive.css">
  <script src="js/auth-guard.js" defer></script>
  <script src="js/wish.js" defer></script>
  <link rel="stylesheet" href="css/animations.css">
  <script src="js/ui.js" defer></script>
  <script src="js/imageHelper.js"></script>
  <script type="module" src="js/api.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* üëç Thumb burst animation */
    @keyframes thumb-burst {
      0% { transform: translate(0,0) scale(0.6); opacity: 0; }
      40% { transform: translate(6px,-8px) scale(1.1); opacity: 1; }
      100% { transform: translate(12px,-16px) scale(0.9); opacity: 0; }
    }
    .thumb-float {
      animation: thumb-burst 650ms ease-out forwards;
      pointer-events: none;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans">

  <!-- Top Bar -->
  <header class="sticky-header bg-white border-b border-gray-100 shadow-sm">
    <div class="max-w-6xl mx-auto px-4 lg:px-6 h-14 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <a href="index.html" class="text-gray-600 hover:text-green-600 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </a>
        <img src="assets/tindo-logo.jpg" alt="Tindo Logo" class="w-10 h-10 rounded-full" onerror="this.src='assets/tindo-logo.jpg'">
        <span class="font-semibold text-gray-900 hidden sm:inline">Tindo</span>
      </div>
      <div class="flex items-center gap-3 text-sm">
        <a href="index.html" class="text-gray-700 hover:text-green-700 font-semibold flex items-center gap-1 hidden sm:flex"><i data-lucide="home"></i> <span class="hidden md:inline">Home</span></a>
        <a href="cart.html" class="text-gray-700 hover:text-green-700 font-semibold flex items-center gap-1 relative">
          <i data-lucide="shopping-cart"></i>
          <span class="hidden md:inline">Cart</span>
          <span id="cartCountRestaurant" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold" style="display: none;">0</span>
        </a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 lg:px-6 pb-24">
    <!-- Restaurant hero -->
    <section class="mt-6 bg-white rounded-2xl shadow overflow-hidden">
      <div class="relative h-48 sm:h-64 md:h-72 bg-gray-100">
        <img id="restaurant-image" src="assets/png.jpg" alt="Restaurant" class="w-full h-full object-cover" onerror="this.src='assets/png.jpg'">
        <div class="absolute inset-0 bg-gradient-to-t from-black/25 to-transparent"></div>
      </div>
      <div class="p-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="space-y-2">
          <div class="flex items-center gap-3 flex-wrap">
            <h1 id="restaurant-name" class="text-3xl font-bold text-gray-900">Restaurant Name</h1>
            <span id="restaurant-rating" class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm font-semibold">‚òÖ 4.5</span>
          </div>
          <p id="restaurant-desc" class="text-gray-600 max-w-3xl">Authentic taste, hot and fresh meals served with love üíö</p>
          <div class="flex items-center gap-3 text-sm text-gray-700">
            <span id="restaurant-eta" class="inline-flex items-center gap-1">‚è±Ô∏è 25-30 mins</span>
            <span class="hidden sm:inline text-gray-300">‚Ä¢</span>
            <span class="inline-flex items-center gap-1 text-amber-600 font-semibold">Fast delivery</span>
          </div>
        </div>
        <div class="bg-green-50 border border-green-100 px-4 py-3 rounded-xl text-green-700 text-sm shadow-sm">
          Quality assured ‚Ä¢ Contactless delivery
        </div>
      </div>
    </section>

    <!-- Menu + Cart layout -->
    <section class="mt-8 grid lg:grid-cols-[1.7fr_1fr] gap-6 items-start">
      <!-- Menu side -->
      <div class="space-y-6">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 flex items-center justify-between gap-3">
          <div class="flex items-center gap-2 text-gray-800 font-semibold"><i data-lucide="list"></i> Menu</div>
          <div id="menuFilterControl" class="relative inline-flex bg-gray-100 rounded-full p-1" role="tablist" aria-label="Menu filter">
            <div class="seg-item relative z-10 px-4 py-2 rounded-full text-sm text-gray-700 cursor-pointer select-none" data-value="all">All</div>
            <div class="seg-item relative z-10 px-4 py-2 rounded-full text-sm text-gray-700 cursor-pointer select-none" data-value="veg">ü•¨ Veg</div>
            <div class="seg-item relative z-10 px-4 py-2 rounded-full text-sm text-gray-700 cursor-pointer select-none" data-value="non-veg">üçó Non‚ÄëVeg</div>
            <div id="segIndicator" class="absolute top-1 bottom-1 left-1 rounded-full bg-white shadow transition-all" style="width:0; transform:translateX(0); z-index:0;"></div>
          </div>
        </div>

        <div id="menu-list" class="grid grid-cols-1 sm:grid-cols-2 gap-5"></div>

        <div id="no-dishes" class="text-center text-gray-500 text-lg py-10 hidden">
          No dishes available yet üçΩÔ∏è
        </div>
      </div>

      <!-- Cart side -->
      <aside class="lg:sticky lg:top-24">
        <div id="cart-panel" class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden flex flex-col">
          <div class="h-full flex flex-col">
            <div class="flex items-center justify-between p-4 border-b bg-gray-50">
              <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2"><i data-lucide="shopping-bag"></i> Your Cart</h3>
              <button id="collapse-cart" class="text-gray-500 hover:text-gray-800 px-2 lg:hidden">‚úï</button>
            </div>
            <div id="cart-panel-content" class="p-4 overflow-auto flex-1 space-y-4"></div>
            <div id="cart-panel-summary" class="p-4 border-t hidden bg-gray-50">
              <div class="flex justify-between text-lg mb-2">
                <span>Subtotal</span>
                <span id="panel-subtotal" class="font-semibold">‚Çπ0</span>
              </div>
              <div class="flex justify-between text-lg mb-4">
                <span>Delivery Fee</span>
                <span id="panel-delivery" class="font-semibold text-green-700">‚Çπ30</span>
              </div>
              <div class="flex justify-between text-xl font-bold border-t pt-3">
                <span>Total</span>
                <span id="panel-total">‚Çπ0</span>
              </div>
            <!-- Desktop checkout button -->
            <div class="hidden md:flex mt-4 gap-3">
              <button id="panel-proceed" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">Checkout</button>
              <button id="panel-clear" class="flex-1 border-2 border-green-600 text-green-700 py-2 rounded-lg hover:bg-green-50 transition">Clear</button>
            </div>
            <!-- Mobile swipe-to-checkout slider -->
            <div class="md:hidden mt-4 flex flex-col gap-2">
              <div id="mobile-swipe-slider" class="relative h-16 bg-gradient-to-r from-green-500 to-green-600 rounded-2xl overflow-hidden cursor-grab active:cursor-grabbing flex items-center select-none px-3" role="slider" aria-label="Swipe to checkout" aria-live="polite">
                <div id="swipe-progress" class="absolute inset-0 bg-green-600 opacity-0" aria-hidden="true"></div>
                <div id="swipe-label" class="absolute inset-0 flex items-center justify-center text-white font-semibold text-sm pointer-events-none">Swipe to checkout</div>
                <div id="swipe-bike" class="relative w-14 h-14 bg-white rounded-full shadow-lg flex items-center justify-center z-10">
                  <div class="bike-body"></div>
                  <div class="bike-wheel wheel-left"></div>
                  <div class="bike-wheel wheel-right"></div>
                </div>
              </div>
              <button id="panel-clear" class="w-full border-2 border-green-600 text-green-700 py-2 rounded-lg hover:bg-green-50 transition">Clear</button>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <!-- Mobile cart trigger -->
  <button id="open-cart-btn" aria-label="Open cart" class="lg:hidden fixed bottom-5 left-4 right-4 bg-green-600 text-white py-3 rounded-full shadow-lg flex items-center justify-center gap-2 z-40" data-ripple>
    <i data-lucide="shopping-bag"></i> View Cart
  </button>

  <style>
    /* ========== MOBILE CART BOTTOM SHEET ========== */
    @media (max-width: 767px) {
      #cart-panel {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: 100vh;
        max-height: 85vh;
        background: white;
        border-radius: 20px 20px 0 0;
        transform: translateY(100%);
        transition: transform 300ms cubic-bezier(0.34, 1.56, 0.64, 1);
        z-index: 45;
        box-shadow: 0 -5px 40px rgba(0, 0, 0, 0.15);
        overflow: hidden;
      }
      #cart-panel.open {
        transform: translateY(0);
      }
    }

    /* ========== DESKTOP STICKY CART ========== */
    @media (min-width: 1024px) {
      #cart-panel {
        position: sticky !important;
        left: auto !important;
        right: auto !important;
        bottom: auto !important;
        max-height: calc(100vh - 140px) !important;
        transform: none !important;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        z-index: auto;
      }
      #cart-panel.open { transform: none !important; }
      #open-cart-btn { display: none; }
      #mobile-swipe-slider { display: none !important; }
    }

    /* ========== SWIPE SLIDER STYLING ========== */
    #mobile-swipe-slider {
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      padding-left: 12px;
      padding-right: 12px;
    }

    #swipe-progress {
      width: 0%;
      opacity: 0;
      transition: width 260ms ease, opacity 200ms ease;
      will-change: width, opacity;
    }

    #swipe-bike {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
      transform: translateX(0);
      transition: transform 260ms cubic-bezier(0.25, 0.9, 0.3, 1);
      will-change: transform;
    }

    #swipe-bike.dragging {
      transition: none;
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
    }

    .bike-body {
      width: 24px;
      height: 12px;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      border-radius: 6px;
      position: relative;
      top: -2px;
    }

    .bike-wheel {
      width: 12px;
      height: 12px;
      border: 2px solid #16a34a;
      border-radius: 50%;
      position: absolute;
      bottom: 2px;
      background: radial-gradient(circle at 50% 50%, #22c55e 0%, #16a34a 50%, transparent 55%);
      transform: rotate(var(--wheel-rotation, 0deg));
      transition: transform 260ms linear;
    }

    #swipe-bike.dragging .bike-wheel { transition: none; }

    .wheel-left { left: 8px; }
    .wheel-right { right: 8px; }

    #swipe-label {
      transition: opacity 160ms ease;
    }

    #swipe-progress {
      background: rgba(255, 255, 255, 0.2);
    }

    #swipe-progress.active {
      opacity: 1 !important;
    }

    /* ========== MOBILE BUTTON STYLING ========== */
    #open-cart-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
      transition: all 200ms ease;
      z-index: 40;
    }

    #open-cart-btn:active {
      transform: translateY(0px);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
    }

    /* ========== GENERAL ========== */
    .cart-item:hover .hover-controls { opacity: 1; transform: translateX(0); }
    .hover-controls { opacity: 0; transform: translateX(6px); transition: all 160ms ease; }

    /* Prevent text selection during interaction */
    #mobile-swipe-slider * {
      pointer-events: none;
    }
  </style>

  <!-- Footer -->
  <footer class="text-center mt-16 py-6 text-gray-500 text-sm">
    ¬© 2025 Tindo ‚Äì Mana Tindi, Mana App
  </footer>

  <script>
    lucide.createIcons();
    // Use API root (no trailing resource) so we can call multiple endpoints
    const API_BASE_URL = window.API_BASE_URL || "https://food-delivery-backend-cw3m.onrender.com/api";
    const token = localStorage.getItem('token');
    const authHeaders = token ? { Authorization: `Bearer ${token}` } : {};
    // IMAGE_BASE_URL & PLACEHOLDER_IMAGE already defined in imageHelper.js

    const restaurantId = new URLSearchParams(window.location.search).get('id');
    console.log('Debug: restaurantId from URL =', restaurantId);

    // Validate restaurantId before making API calls
    if (!restaurantId) {
      console.error("Error: Missing restaurantId in URL");
      document.getElementById('no-dishes').textContent = "Invalid restaurant ID üòî";
      document.getElementById('no-dishes').classList.remove('hidden');
    } else {
      // ===== Fetch restaurant details AND menu items =====
      console.log("Debug: Fetching restaurant & menu for restaurantId =", restaurantId);

      // Helper function to normalize image URLs (convert HTTP to HTTPS for production)
      function normalizeImageUrl(url) {
        if (!url) return null;
        // Convert http:// to https:// for mixed content prevention
        return String(url).replace(/^http:\/\//i, 'https://');
      }

      async function fetchRestaurantAndMenu(id) {
        try {
          // Fetch restaurant details from /api/restaurants/:id
          const restaurantUrl = `${API_BASE_URL}/restaurants/${id}`;
          console.log('Fetching restaurant from:', restaurantUrl);
          const restaurantRes = await fetch(restaurantUrl, { headers: authHeaders });
          
          if (!restaurantRes.ok) {
            throw new Error(`Restaurant API Error: ${restaurantRes.status}`);
          }
          
          const restaurantData = await restaurantRes.json();
          console.log('Restaurant API Response:', restaurantData);
          
          let restaurant = (restaurantData && restaurantData.success && restaurantData.data) 
            ? restaurantData.data 
            : null;
          
          // Normalize image URLs to HTTPS to prevent mixed content warnings
          if (restaurant && restaurant.image_url_full) {
            restaurant.image_url_full = normalizeImageUrl(restaurant.image_url_full);
          }
          
          // Fetch menu items from /api/menu/restaurant/:id
          const menuUrl = `${API_BASE_URL}/menu/restaurant/${id}`;
          console.log('Fetching menu from:', menuUrl);
          const menuRes = await fetch(menuUrl, { headers: authHeaders });
          
          if (!menuRes.ok) {
            throw new Error(`Menu API Error: ${menuRes.status}`);
          }
          
          const menuData = await menuRes.json();
          console.log('Menu API Response:', menuData);
          
          // Backend returns { success: true, data: [...items] } for menu
          // Note: data is an ARRAY of items, not an object
          let items = [];
          if (menuData && menuData.success && Array.isArray(menuData.data)) {
            items = menuData.data;
          } else if (menuData && Array.isArray(menuData.data)) {
            items = menuData.data;
          }
          
          // Normalize image URLs in menu items to HTTPS
          if (items && Array.isArray(items)) {
            items.forEach(item => {
              if (item.image_url_full) {
                item.image_url_full = normalizeImageUrl(item.image_url_full);
              }
            });
          }
          
          return { restaurant, items };
        } catch (err) {
          console.error('Fetch error:', err.message);
          throw err;
        }
      }

      fetchRestaurantAndMenu(restaurantId)
        .then(({ restaurant, items }) => {
          // ===== Render restaurant banner =====
          if (restaurant) {
            document.getElementById('restaurant-name').textContent = restaurant.name || 'Restaurant';
            document.getElementById('restaurant-desc').textContent = restaurant.description || 'Delicious food from Tindo partner restaurant üç¥';
            document.getElementById('restaurant-eta').textContent = `‚è±Ô∏è ${restaurant.eta || 30} mins delivery`;
            const ratingEl = document.getElementById('restaurant-rating');
            if (ratingEl) ratingEl.textContent = `‚òÖ ${restaurant.rating || '4.2'}`;
            
            // Set restaurant image - use direct URLs from database
            const imgEl = document.getElementById('restaurant-image');
            if (restaurant.image_url_full) {
              imgEl.src = restaurant.image_url_full;
            } else if (restaurant.image_url && String(restaurant.image_url).startsWith('http')) {
              imgEl.src = restaurant.image_url;
            }
            addImageErrorHandler(imgEl);
            console.log('Restaurant loaded:', restaurant.name);
          } else {
            console.warn('Restaurant details missing; header will use defaults');
          }

          // ===== Prepare menu items =====
          console.log('Debug: Items fetched =', items, 'Count:', items.length);
          window.__restaurantDishes = items || [];
          window.__menuIndex = window.__menuIndex || {};
          
          if (items && Array.isArray(items) && items.length > 0) {
            items.forEach((item, idx) => {
              // Primary ID field from backend
              const itemId = item.id || item.item_id || (idx + 1);
              item._client_id = itemId;
              
              window.__menuIndex[itemId] = {
                name: item.item_name || item.name || 'Item',
                price: Number(item.price || 0),
                image_url: item.image_url || '',
                image_url_full: item.image_url_full || null,
                restaurant_id: Number(restaurantId)
              };
            });
            console.log('Menu index populated with', items.length, 'items');
          } else {
            console.warn('No menu items found');
          }
          
          renderMenu();
        })
        .catch(err => {
          console.error('Error fetching restaurant/menu:', err.message);
          const msg = err && err.message && err.message.includes('401')
            ? 'Session expired. Please log in again to view this restaurant.'
            : 'Failed to load menu üòî';
          document.getElementById('no-dishes').textContent = msg;
          document.getElementById('no-dishes').classList.remove('hidden');
        });
    }

    function addToCartUI(dishId) {
      const meta = (window.__menuIndex && window.__menuIndex[dishId]) || null;
      if (!meta) return;
      // Update cart (single restaurant flow honored elsewhere)
      let cart = JSON.parse(localStorage.getItem('tindo_cart') || '[]');
      let existing = cart.find(i => i.name === meta.name && i.restaurant_id === meta.restaurant_id);
      if (existing) {
        existing.qty = (existing.qty || 0) + 1;
      } else {
        existing = { name: meta.name, price: meta.price, image_url: meta.image_url, restaurant_id: meta.restaurant_id, qty: 1 };
        cart.push(existing);
      }
      localStorage.setItem('tindo_cart', JSON.stringify(cart));

      // UI: change button label, show qty row, animate thumb
      const btn = document.getElementById(`add-btn-${dishId}`);
      const qtyRow = document.getElementById(`qty-row-${dishId}`);
      const qtyEl = document.getElementById(`qty-${dishId}`);
      if (btn) {
        const lbl = btn.querySelector('.btn-label');
        if (lbl) lbl.textContent = 'Added to Cart';
        // thumb animation element
        const span = document.createElement('span');
        span.textContent = 'üëç';
        span.className = 'thumb-float absolute right-3 -top-2 text-xl';
        btn.appendChild(span);
        setTimeout(() => { if (span && span.parentNode) span.parentNode.removeChild(span); }, 700);
      }
      if (qtyRow) qtyRow.classList.remove('hidden');
      if (qtyEl) qtyEl.textContent = String(existing.qty || 1);

      // Keep cart panel and other buttons in sync
      renderCartPanel();
      syncMenuButtons();
    }

    function changeQtyUI(dishId, delta) {
      const meta = (window.__menuIndex && window.__menuIndex[dishId]) || null;
      if (!meta) return;
      let cart = JSON.parse(localStorage.getItem('tindo_cart') || '[]');
      const idx = cart.findIndex(i => i.name === meta.name && i.restaurant_id === meta.restaurant_id);
      if (idx === -1) {
        if (delta > 0) {
          cart.push({ name: meta.name, price: meta.price, image_url: meta.image_url, restaurant_id: meta.restaurant_id, qty: 1 });
        }
      } else {
        cart[idx].qty = Math.max(0, (cart[idx].qty || 0) + delta);
        if (cart[idx].qty === 0) cart.splice(idx, 1);
      }
      localStorage.setItem('tindo_cart', JSON.stringify(cart));
      // Update UI
      const qtyRow = document.getElementById(`qty-row-${dishId}`);
      const qtyEl = document.getElementById(`qty-${dishId}`);
      const qtyVal = (cart.find(i => i.name === meta.name && i.restaurant_id === meta.restaurant_id) || {}).qty || 0;
      if (qtyEl) qtyEl.textContent = String(qtyVal);
      if (qtyRow && qtyVal <= 0) qtyRow.classList.add('hidden');

      // Keep cart panel and other buttons in sync
      renderCartPanel();
      syncMenuButtons();
    }

    // ‚ù§Ô∏è Like
    function likeDish(btn) {
      btn.classList.toggle('text-red-500');
      btn.classList.toggle('text-gray-400');
    }

    // üëÅÔ∏è View Details Popup
    function viewDetails(name, desc, price, img) {
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50";
      
      // Use getMenuImageUrl helper for consistency, or check if URL is external
      const safeSrc = (typeof window !== 'undefined' && typeof getMenuImageUrl === 'function')
        ? getMenuImageUrl(img, null)
        : (img && String(img).startsWith('http') ? img : 'assets/png.jpg');
      
      modal.innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm text-center relative">
          <img src="${safeSrc}" class="w-full h-48 object-cover rounded-xl mb-3" onerror="this.src='assets/png.jpg'">
          <h3 class="text-xl font-bold text-green-700 mb-1">${name}</h3>
          <p class="text-gray-600 mb-2">${desc || ''}</p>
          <p class="text-green-700 font-bold text-lg mb-4">‚Çπ${price}</p>
          <button onclick="this.parentElement.parentElement.remove()" class="bg-green-600 text-white px-6 py-2 rounded-xl hover:bg-green-700 transition">Close</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // ===== MOBILE SCROLL LOCK UTILITIES =====
    function lockBodyScroll() {
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
    }
    
    function unlockBodyScroll() {
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
    }

    // ===== Right-side Cart Panel Logic =====
    const CART_KEY = 'tindo_cart';
    const openCartBtn = document.getElementById('open-cart-btn');
    const cartPanel = document.getElementById('cart-panel');
    const collapseCart = document.getElementById('collapse-cart');
    const cartPanelContent = document.getElementById('cart-panel-content');
    const panelSubtotal = document.getElementById('panel-subtotal');
    const panelTotal = document.getElementById('panel-total');
    const panelSummary = document.getElementById('cart-panel-summary');
    const panelProceed = document.getElementById('panel-proceed');
    const panelClear = document.getElementById('panel-clear');

    function isMobileView() {
      return window.innerWidth < 768;
    }

    function openCartPanel() {
      cartPanel.classList.add('open');
      renderCartPanel();
      if (isMobileView()) {
        lockBodyScroll();
      }
    }
    
    function closeCartPanel() {
      cartPanel.classList.remove('open');
      if (isMobileView()) {
        unlockBodyScroll();
      }
    }

    openCartBtn.addEventListener('click', openCartPanel);
    collapseCart.addEventListener('click', closeCartPanel);

    cartPanel.addEventListener('click', (e) => {
      if (e.target === cartPanel && isMobileView()) closeCartPanel();
    });

    function getCart() {
      return JSON.parse(localStorage.getItem(CART_KEY) || '[]');
    }

    function renderCartPanel() {
      const cart = getCart();
      cartPanelContent.innerHTML = '';
      if (!cart.length) {
        cartPanelContent.innerHTML = `<div class="p-6 text-center text-gray-500">Your cart is empty üçΩÔ∏è<br><a href=\"#\" onclick=\"closeCartPanel()\" class=\"text-green-600 underline mt-3 inline-block\">Continue shopping</a></div>`;
        panelSummary.classList.add('hidden');
        return;
      }
      panelSummary.classList.remove('hidden');
      let subtotal = 0;
      cart.forEach((item, idx) => {
        subtotal += item.price * item.qty;
        const node = document.createElement('div');
        node.className = 'cart-item flex items-center justify-between gap-3 p-3 rounded-lg border bg-gray-50';
        const cartImgSrc = getMenuImageUrl(item.image_url, item.image_url_full);
        node.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="${cartImgSrc}" class="w-14 h-14 object-cover rounded-lg border" alt="${item.name}" onerror="this.src='assets/png.jpg'">
            <div>
              <div class="font-semibold text-green-700">${item.name}</div>
              <div class="text-sm text-gray-500">‚Çπ${item.price} √ó ${item.qty}</div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div class="hover-controls flex items-center gap-2">
              <button onclick="panelChangeQty(${idx}, -1)" class="w-8 h-8 rounded-full bg-green-100 hover:bg-green-200 text-green-700">‚àí</button>
              <button onclick="panelChangeQty(${idx}, 1)" class="w-8 h-8 rounded-full bg-green-100 hover:bg-green-200 text-green-700">+</button>
              <button onclick="panelRemoveItem(${idx})" class="text-red-500 hover:text-red-700">‚úñ</button>
            </div>
          </div>
        `;
        cartPanelContent.appendChild(node);
      });
      panelSubtotal.textContent = `‚Çπ${subtotal}`;
      panelTotal.textContent = `‚Çπ${subtotal + 30}`;
    }

    window.panelChangeQty = function(index, delta) {
      const cart = getCart();
      if (!cart[index]) return;
      cart[index].qty = Math.max(0, (cart[index].qty || 0) + delta);
      if (cart[index].qty === 0) cart.splice(index, 1);
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      renderCartPanel();
      // Also update dish buttons UI (if present)
      syncMenuButtons();
    }

    window.panelRemoveItem = function(index) {
      const cart = getCart();
      if (!cart[index]) return;
      cart.splice(index, 1);
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      renderCartPanel();
      syncMenuButtons();
    }

    panelClear.addEventListener('click', () => {
      localStorage.removeItem(CART_KEY);
      renderCartPanel();
      syncMenuButtons();
    });


    // Render panel on load (but keep closed)
    document.addEventListener('DOMContentLoaded', () => { renderCartPanel(); syncMenuButtons(); });

    // ===== Menu render + veg/non-veg filter =====
    // helper to determine if item is veg
    function isVegItem(dish){
      if(!dish) return false;
      const v = dish.is_veg ?? dish.isVeg ?? dish.veg ?? dish.type ?? dish.category ?? '';
      if(typeof v === 'boolean') return v === true;
      if(typeof v === 'number') return v === 1;
      return String(v).toLowerCase().includes('veg') && !String(v).toLowerCase().includes('non');
    }
    window.__menuFilter = window.__menuFilter || 'all';
        // ===== CHECKOUT HANDLER =====
        function proceedToCheckout() {
          const cart = getCart();
          if (!cart.length) return alert('Your cart is empty!');
          localStorage.setItem('cartItems', JSON.stringify(cart));
          localStorage.setItem('selectedRestaurantId', cart[0]?.restaurant_id || restaurantId);
          window.location.href = 'user-address.html';
        }

        if (panelProceed) {
          panelProceed.addEventListener('click', proceedToCheckout);
        }

        // ===== MOBILE SWIPE-TO-CHECKOUT LOGIC =====
        const swipeSlider = document.getElementById('mobile-swipe-slider');
        const swipeBike = document.getElementById('swipe-bike');
        const swipeProgress = document.getElementById('swipe-progress');
        const swipeLabel = document.getElementById('swipe-label');
        let isDragging = false;
        let startX = 0;
        let translateX = 0;
        let maxTranslate = 0;
        let sliderRect = null;
        let rafId = null;
        const padding = 12; // matches slider horizontal padding
        const successThreshold = 0.65;
        const minIntentPx = 8;
        const preventScroll = (evt) => { if (isDragging) evt.preventDefault(); };

        function setBikePosition(x, progress) {
          swipeBike.style.transform = `translateX(${x}px)`;
          swipeProgress.style.width = `${Math.min(100, Math.max(0, (x + swipeBike.offsetWidth * 0.5) / sliderRect.width * 100))}%`;
          swipeProgress.style.opacity = progress > 0.02 ? 0.25 + progress * 0.4 : 0;
          const rotation = Math.min(720, progress * 900);
          swipeBike.style.setProperty('--wheel-rotation', `${rotation}deg`);
          swipeBike.querySelectorAll('.bike-wheel').forEach(w => w.style.transform = `rotate(${rotation}deg)`);
          if (swipeLabel) swipeLabel.style.opacity = progress > 0.15 ? 0.6 : 1;
        }

        function animateBike() {
          const clamped = Math.max(0, Math.min(translateX, maxTranslate));
          const progress = maxTranslate === 0 ? 0 : clamped / maxTranslate;
          setBikePosition(padding + clamped, progress);
          rafId = null;
        }

        function handleSwipeStart(e) {
          if (!isMobileView()) return;
          const cart = getCart();
          if (!cart.length) { e.preventDefault(); return; }
          sliderRect = swipeSlider.getBoundingClientRect();
          const bikeWidth = swipeBike.offsetWidth;
          maxTranslate = Math.max(0, sliderRect.width - bikeWidth - padding * 2);
          startX = e.clientX || (e.touches && e.touches[0]?.clientX) || 0;
          translateX = 0;
          isDragging = true;
          swipeBike.classList.add('dragging');
          swipeBike.style.transition = 'none';
          swipeProgress.style.transition = 'none';
          swipeSlider.style.cursor = 'grabbing';
          document.addEventListener('touchmove', preventScroll, { passive: false });
          e.preventDefault();
        }

        function handleSwipeMove(e) {
          if (!isDragging || !sliderRect) return;
          const currentX = e.clientX || (e.touches && e.touches[0]?.clientX) || startX;
          const delta = currentX - startX;
          if (Math.abs(delta) < minIntentPx && translateX === 0) { e.preventDefault(); return; }
          translateX = Math.max(0, Math.min(delta, maxTranslate));
          if (!rafId) rafId = requestAnimationFrame(animateBike);
          e.preventDefault();
        }

        function resetBike() {
          swipeBike.classList.remove('dragging');
          swipeBike.style.transition = 'transform 320ms cubic-bezier(0.25, 1.4, 0.4, 1)';
          swipeProgress.style.transition = 'width 260ms ease, opacity 200ms ease';
          setBikePosition(padding, 0);
        }

        function completeBikeSwipe() {
          swipeBike.classList.remove('dragging');
          swipeBike.style.transition = 'transform 200ms ease-out';
          swipeProgress.style.transition = 'width 200ms ease, opacity 200ms ease';
          setBikePosition(padding + maxTranslate, 1);
          if (navigator.vibrate) navigator.vibrate(100);
          closeCartPanel();
          setTimeout(proceedToCheckout, 180);
        }

        function handleSwipeEnd(e) {
          if (!isDragging || !sliderRect) return;
          isDragging = false;
          swipeSlider.style.cursor = 'grab';
          document.removeEventListener('touchmove', preventScroll, { passive: false });
          const currentX = e?.clientX || (e?.changedTouches && e.changedTouches[0]?.clientX) || (startX + translateX);
          const delta = currentX - startX;
          const progress = maxTranslate === 0 ? 0 : Math.max(0, Math.min(delta, maxTranslate)) / maxTranslate;
          if (progress >= successThreshold) {
            completeBikeSwipe();
          } else {
            resetBike();
          }
          e.preventDefault();
        }

        function enableSwipe() {
          if (!isMobileView() || !swipeSlider) return;
          swipeSlider.addEventListener('pointerdown', handleSwipeStart, { passive: false });
          swipeSlider.addEventListener('touchstart', handleSwipeStart, { passive: false });
          swipeSlider.addEventListener('pointermove', handleSwipeMove, { passive: false });
          swipeSlider.addEventListener('touchmove', handleSwipeMove, { passive: false });
          swipeSlider.addEventListener('pointerup', handleSwipeEnd, { passive: false });
          swipeSlider.addEventListener('touchend', handleSwipeEnd, { passive: false });
          swipeSlider.addEventListener('pointercancel', handleSwipeEnd, { passive: false });
          swipeSlider.addEventListener('touchcancel', handleSwipeEnd, { passive: false });
        }

        function disableSwipe() {
          if (!swipeSlider) return;
          swipeSlider.removeEventListener('pointerdown', handleSwipeStart);
          swipeSlider.removeEventListener('touchstart', handleSwipeStart);
          swipeSlider.removeEventListener('pointermove', handleSwipeMove);
          swipeSlider.removeEventListener('touchmove', handleSwipeMove);
          swipeSlider.removeEventListener('pointerup', handleSwipeEnd);
          swipeSlider.removeEventListener('touchend', handleSwipeEnd);
          swipeSlider.removeEventListener('pointercancel', handleSwipeEnd);
          swipeSlider.removeEventListener('touchcancel', handleSwipeEnd);
          document.removeEventListener('touchmove', preventScroll, { passive: false });
          if (swipeBike && swipeProgress) {
            sliderRect = swipeSlider.getBoundingClientRect();
            setBikePosition(padding, 0);
          }
        }

        enableSwipe();
        window.addEventListener('resize', () => {
          if (!isMobileView()) disableSwipe();
          else enableSwipe();
        });

        // Render panel on load (but keep closed)
        document.addEventListener('DOMContentLoaded', () => {
          renderCartPanel();
          syncMenuButtons();
          unlockBodyScroll();
          if (swipeSlider && swipeBike) {
            sliderRect = swipeSlider.getBoundingClientRect();
            setBikePosition(padding, 0);
          }
        });

        window.addEventListener('beforeunload', () => {
          unlockBodyScroll();
        });
    function renderMenu(){
      const menuList = document.getElementById('menu-list');
      const emptyMsg = document.getElementById('no-dishes');
      menuList.innerHTML = '';
      const all = window.__restaurantDishes || [];
      const filtered = all.filter(d => {
        if(!d) return false;
        if(window.__menuFilter === 'all') return true;
        if(window.__menuFilter === 'veg') return isVegItem(d);
        if(window.__menuFilter === 'non-veg') return !isVegItem(d);
        return true;
      });
      if(!filtered.length){
        emptyMsg.textContent = "No dishes available yet üçΩÔ∏è";
        emptyMsg.classList.remove('hidden');
        return;
      }
      emptyMsg.classList.add('hidden');
      filtered.forEach((dish, idx) => {
        const card = document.createElement('div');
        card.className = "card hover-lift p-4 shadow transition border border-gray-100 relative group reveal";
        const did = Number(dish._client_id ?? dish.id ?? dish.item_id ?? dish.menu_id ?? dish.dish_id ?? dish._id ?? (idx + 1));
        // ensure menu index exists
        window.__menuIndex = window.__menuIndex || {};
        window.__menuIndex[did] = {
          name: dish.item_name ?? dish.name ?? dish.title ?? `Item ${did}`,
          price: Number(dish.price ?? dish.cost ?? dish.amount ?? 0),
          image_url: dish.image_url ?? dish.imageUrl ?? dish.image ?? dish.photo ?? '',
          image_url_full: dish.image_url_full ?? dish.imageUrlFull ?? dish.image_full ?? null,
          restaurant_id: Number(restaurantId)
        };
        // veg badge
        const vegBadge = isVegItem(dish) ? `<span class="absolute top-3 right-3 bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs">ü•¨ Veg</span>` : `<span class="absolute top-3 right-3 bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs">üçó Non‚ÄëVeg</span>`;
        const metaImgFull = window.__menuIndex[did].image_url_full;
        const metaImg = window.__menuIndex[did].image_url;
        const dishImageSrc = getMenuImageUrl(metaImg, metaImgFull);
        const dishImgHtml = `<img src="${dishImageSrc}" class="w-full h-44 object-cover rounded-xl mb-3" onerror="this.src='assets/png.jpg'">`;
        card.innerHTML = `
          ${vegBadge}
          ${dishImgHtml}
          <h4 class="text-lg font-semibold text-green-700">${dish.item_name ?? dish.name ?? dish.title ?? 'Item'}</h4>
          <p class="text-gray-600 mb-2">${dish.description ?? dish.desc ?? dish.details ?? ''}</p>
          <p class="text-green-700 font-bold text-lg mb-2">‚Çπ${dish.price ?? dish.cost ?? dish.amount ?? 0}</p>
          <button id="add-btn-${did}" onclick="addToCartUI(${did})" data-wish data-ripple class="btn btn-primary w-full relative flex items-center justify-center gap-2">
            <span class="btn-label">Add to Cart</span>
          </button>
          <div id="qty-row-${did}" class="hidden mt-3">
            <div class="flex items-center justify-between">
              <div class="inline-flex items-center gap-3">
                <button class="w-9 h-9 rounded-full border text-green-700 border-green-200 hover:bg-green-50" onclick="changeQtyUI(${did}, -1)">‚àí</button>
                <span id="qty-${did}" class="min-w-6 text-center font-semibold">1</span>
                <button class="w-9 h-9 rounded-full border text-green-700 border-green-200 hover:bg-green-50" onclick="changeQtyUI(${did}, 1)">+</button>
              </div>
              <div class="text-sm text-gray-500">Updated in cart</div>
            </div>
          </div>
        `;
        menuList.appendChild(card);
      });
      // sync cart state
      syncMenuButtons();
    }

    // setup segmented filter control (modern toggle)
    (function(){
      const ctrl = document.getElementById('menuFilterControl');
      const indicator = document.getElementById('segIndicator');
      if(!ctrl || !indicator) return;
      const items = Array.from(ctrl.querySelectorAll('[data-value]'));

      function setFilter(f){
        window.__menuFilter = f;
        const parentRect = ctrl.getBoundingClientRect();
        const selected = items.find(it => it.dataset.value === f) || items[0];
        const selRect = selected.getBoundingClientRect();
        // move indicator
        indicator.style.width = `${selRect.width}px`;
        indicator.style.transform = `translateX(${selRect.left - parentRect.left}px)`;
        // style items
        items.forEach(it => {
          it.classList.remove('text-white','text-green-700','text-red-700','text-gray-900','font-semibold');
          if (it.dataset.value === f) {
            it.classList.add('font-semibold');
            if (f === 'veg') it.classList.add('text-green-700');
            else if (f === 'non-veg') it.classList.add('text-red-700');
            else it.classList.add('text-gray-900');
          } else {
            it.classList.add('text-gray-700');
          }
        });
        renderMenu();
      }

      items.forEach(it => it.addEventListener('click', () => setFilter(it.dataset.value)));
      // initial (allow layout to settle)
      setTimeout(() => setFilter(window.__menuFilter || 'all'), 50);
    })();
  </script>
</body>
</html>
