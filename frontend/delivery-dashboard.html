<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tindo Delivery Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Mappls Advanced Maps SDK -->
  <script src="https://apis.mappls.com/advancedmaps/api/522d3498e3667eac0fc7f509c00ac75a/map_sdk?v=3.0&layer=vector"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="js/wish.js" defer></script>
  <!-- If developer opened this file directly (file://), redirect to the local dev server so assets and APIs load correctly -->
  <script>
    try {
      if (location.protocol === 'file:') {
        // preserve pathname if possible, otherwise redirect to default served path
        const served = 'https://food-delivery-backend-cw3m.onrender.com/delivery-dashboard.html';
        console.info('Opened via file:// ‚Äî redirecting to', served);
        window.location.replace(served);
      }
    } catch (e) { /* ignore in restricted contexts */ }
  </script>
</head>
<body class="bg-green-50 text-gray-900">

<!-- Navbar -->
<header class="bg-white shadow sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-green-600">üö¥ Tindo Delivery</h1>
    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
  </div>
</header>
<div id="deliveryRouteInfo" 
     class="absolute top-3 left-3 bg-white/90 rounded-lg p-3 shadow text-sm z-50"></div>

<!-- Dashboard -->
<section class="max-w-7xl mx-auto p-6">
  <!-- Break/Offline Mode -->
  <div class="bg-white p-6 rounded-xl shadow mb-6 flex items-center justify-between">
    <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><span>‚è≥</span> Availability</h3>
    <div class="flex items-center gap-3">
      <span id="availText" class="text-sm font-semibold px-2 py-1 rounded bg-emerald-50 text-emerald-700 border border-emerald-200">Online</span>
      <label class="relative inline-flex items-center cursor-pointer select-none">
        <input type="checkbox" id="availabilityToggle" class="sr-only peer" checked>
        <div class="w-16 h-9 rounded-full bg-gray-200 transition-all duration-300 peer-focus:ring-4 peer-focus:ring-emerald-200 peer-checked:bg-emerald-500 shadow-inner"></div>
        <div class="absolute top-1 left-1 w-7 h-7 rounded-full bg-white shadow-md transition-all duration-300 peer-checked:translate-x-7 peer-checked:shadow-lg"></div>
      </label>
      <span class="text-xs text-gray-500">Toggle to go Offline for a break</span>
    </div>
  </div>
  <!-- Earnings Tracker -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
  <h3 class="text-2xl font-bold mb-4 text-green-700 flex items-center gap-2"><span>ÔøΩ</span> Earnings Tracker</h3>
    <div class="grid md:grid-cols-2 gap-6">
      <div class="card bg-green-50 p-4 rounded shadow">
        <h4 class="font-bold mb-2">Weekly/Monthly Income</h4>
        <canvas id="earningsChart"></canvas>
      </div>
      <div class="card bg-green-50 p-4 rounded shadow">
        <h4 class="font-bold mb-2">Per-Order Earnings</h4>
        <ul id="orderEarnings" class="space-y-2"></ul>
      </div>
    </div>
  </div>
  <!-- Delivery History -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
  <h3 class="text-2xl font-bold mb-4 text-purple-700 flex items-center gap-2"><span>üïì</span> Delivery History</h3>
    <div id="historyList" class="space-y-3">
      <p class="text-gray-500">No history yet...</p>
    </div>
  </div>
  <h2 class="text-3xl font-bold text-green-600 mb-6">üì¶ My Dashboard</h2>

  <!-- Earnings Summary -->
  <div class="grid md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white p-4 rounded-xl shadow text-center">
      <h3 class="font-bold">Today‚Äôs Earnings</h3>
      <p id="earnToday" class="text-2xl text-green-600">‚Çπ0</p>
    </div>
    <div class="bg-white p-4 rounded-xl shadow text-center">
      <h3 class="font-bold">Weekly Earnings</h3>
      <p id="earnWeek" class="text-2xl text-green-600">‚Çπ0</p>
    </div>
    <div class="bg-white p-4 rounded-xl shadow text-center">
      <h3 class="font-bold">Total Orders</h3>
      <p id="totalOrders" class="text-2xl text-green-600">0</p>
    </div>
  </div>

  <!-- Assigned Orders -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
  <h3 class="text-2xl font-bold mb-4 text-blue-700 flex items-center gap-2"><span>ÔøΩ</span> Assigned Orders</h3>
    <div id="ordersList" class="space-y-3">
      <p class="text-gray-500">No orders yet...</p>
    </div>
  </div>

  <!-- Live Map in scrollable box -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-bold">üó∫Ô∏è My Live Location</h3>
  <button id="btnFullMapDelivery" class="text-gray-700 hover:text-green-700 border px-3 py-1 rounded flex items-center gap-2" title="Fullscreen Map" data-wish>‚§¢ Fullscreen</button>
    </div>
    <div id="map" class="h-96 w-full rounded overflow-hidden" style="max-height: 400px; box-shadow: 0 4px 16px rgba(16,185,129,0.10);"></div>
  </div>

  <!-- Notifications -->
  <div class="bg-white p-6 rounded-xl shadow">
    <h3 class="text-xl font-bold mb-4">üîî Notifications</h3>
    <ul id="notifications" class="space-y-2"></ul>
  </div>
</section>

<script>
  const BASE = "https://food-delivery-backend-cw3m.onrender.com";
  const socket = io(BASE);
  // Resolve agent id from logged-in user
  const loggedUser = (()=>{ try { return JSON.parse(localStorage.getItem('user')); } catch(_) { return null; } })();
  let agentId = 1;
  // Avoid top-level await: resolve agentId asynchronously before init
  (async () => {
    if (loggedUser) {
      try {
        const resp = await fetch(`${BASE}/api/delivery/by-user/${loggedUser.id}`);
        if (resp.ok) {
          const agent = await resp.json();
          agentId = agent.id;
        }
      } catch (_) {}
    }
    // Register socket listeners now that agentId is known
    try {
      socket.on(`orderForAgent_${agentId}`, (order) => {
        showOrderNotification(`üì¶ New Order #${order.id} assigned!`, 'green');
        loadOrders();
      });
      socket.on(`orderCanceled_${agentId}`, (order) => {
        showOrderNotification(`‚ùå Order #${order.id} canceled!`, 'red');
        loadOrders();
      });
      socket.on(`orderDelayed_${agentId}`, (order) => {
        showOrderNotification(`‚è≥ Order #${order.id} delayed!`, 'yellow');
        loadOrders();
      });
    } catch (_) {}
    // Init after agentId is resolved
    loadOrders();
    shareLocation();
  })();

  // Fetch assigned orders
  async function loadOrders() {
  let res = await fetch(`${BASE}/api/delivery/${agentId}/orders`);
    let orders = await res.json();
    renderOrders(orders);
  }

  // Render orders
  function renderOrders(orders) {
    const list = document.getElementById("ordersList");
    list.innerHTML = "";
    orders.forEach(order => {
      const div = document.createElement("div");
      div.className = "card bg-green-50 p-3 rounded shadow";
      const customerName = order.customer_name || 'Unknown';
      const pickupLocation = order.pickup_location || order.restaurant_address || 'N/A';
      div.innerHTML = `
        <p class="font-bold text-lg text-blue-700 mb-1">Order #${order.id}</p>
        <p class="text-sm text-gray-700">Customer: ${customerName}</p>
        <p class="text-sm text-gray-700">Pickup: ${pickupLocation}</p>
        <p class="text-sm text-gray-600">Items: ${JSON.parse(order.items).map(i => i.name).join(", ")}</p>
        <p class="text-sm text-gray-600">Status: ${order.status}</p>
        <div class="mt-3 flex flex-wrap gap-2">
          <button onclick="updateOrder(${order.id}, 'Picked Up')" class="bg-yellow-500 text-white px-4 py-2 rounded-lg shadow hover:bg-yellow-600 transition-all flex items-center gap-1" data-wish><span>üì§</span> Picked</button>
          <button onclick="updateOrder(${order.id}, 'Delivered')" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition-all flex items-center gap-1" data-wish><span>‚úÖ</span> Delivered</button>
          <button onclick="openRouteOptimization('${pickupLocation}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-all flex items-center gap-1"><span>üó∫Ô∏è</span> Route</button>
          <button onclick="chatCustomer('${customerName}')" class="bg-purple-600 text-white px-4 py-2 rounded-lg shadow hover:bg-purple-700 transition-all flex items-center gap-1"><span>üí¨</span> Chat</button>
          <button onclick="callCustomer('${order.customer_phone || ''}')" class="bg-pink-600 text-white px-4 py-2 rounded-lg shadow hover:bg-pink-700 transition-all flex items-center gap-1" data-wish><span>üìû</span> Call</button>
          <button onclick="showProofModal(${order.id})" class="bg-gray-700 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-800 transition-all flex items-center gap-1"><span>üñºÔ∏è</span> Proof</button>
        </div>
      `;
      list.appendChild(div);
    });
  }

  // Update order status
  async function updateOrder(orderId, status) {
  await fetch(`${BASE}/api/delivery/update-order`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ order_id: orderId, status })
    });
    loadOrders();
  }

  // Live location sharing
  function shareLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        if (window.__isAvailable) {
          await fetch(`${BASE}/api/delivery/location`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ agent_id: agentId, lat, lng })
          });
          // Also broadcast live location over Socket.IO for real-time tracking consumers
          try {
            socket.emit("agentLocation", { agentId, lat, lng });
          } catch (_) {}
        }
        updateMap(lat, lng);
      });
    }
  }

  // Mappls main map setup
  let mainMap, mainMarker;
  let lastAgentLat = 17.3850, lastAgentLng = 78.4867;
  let mapplsToken = null; // OAuth for route API

  function initMainMap(){
    mainMap = new mappls.Map('map', { center: [lastAgentLat, lastAgentLng], zoom: 13 });
    mainMarker = new mappls.Marker({ map: mainMap, position: [lastAgentLat, lastAgentLng], popupHtml: 'You (Agent) üö¥' });
  }

  function updateMap(lat, lng) {
    lastAgentLat = lat; lastAgentLng = lng;
    try { if (mainMarker && typeof mainMarker.setPosition === 'function') mainMarker.setPosition([lat, lng]); } catch(_){ }
    try { if (mainMap && typeof mainMap.panTo === 'function') mainMap.panTo([lat, lng]); } catch(_){ }
  }

  // Listen for backend-pushed live location updates (Admin/User view compatibility)
  try {
    socket.on("locationUpdate", ({ agentId: _id, lat, lng }) => {
      // Reuse the existing marker and map
      updateMap(lat, lng);
    });
  } catch (_) {}

  // Notifications are registered after agentId resolution above

  function showOrderNotification(message, color) {
    const noti = document.createElement("li");
    let bg = 'bg-green-100';
    if (color === 'red') bg = 'bg-red-100';
    if (color === 'yellow') bg = 'bg-yellow-100';
    noti.className = `${bg} p-3 rounded shadow`;
    noti.textContent = message;
    document.getElementById("notifications").prepend(noti);
  }

  function logout() {
    alert("Logging out...");
    window.location.href = "login.html";
  }

  // Fetch and display orders for the delivery agent
  async function fetchAgentOrders() {
    try {
      const response = await fetch(`${BASE}/api/orders/agent/${agentId}`);
      if (!response.ok) {
        throw new Error('Failed to fetch agent orders');
      }

      const orders = await response.json();
      console.log('Agent Orders:', orders);

      // Display orders dynamically (example)
      const ordersList = document.getElementById('ordersList');
      ordersList.innerHTML = orders.map(order => `
        <div class="order">
          <p><b>Order ID:</b> ${order.id}</p>
          <p><b>Status:</b> ${order.status}</p>
          <p><b>Total:</b> ‚Çπ${order.total}</p>
        </div>
      `).join('');
    } catch (error) {
      console.error('Error fetching agent orders:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', () => { fetchAgentOrders(); try { initMainMap(); } catch(_){} });

  // Availability switch behavior
  window.__isAvailable = true;
  const toggle = document.getElementById('availabilityToggle');
  const availText = document.getElementById('availText');
  toggle.addEventListener('change', async () => {
    const available = toggle.checked;
    window.__isAvailable = available;
    // Update pill text and styles
    if (available) {
      availText.textContent = 'Online';
      availText.className = 'text-sm font-semibold px-2 py-1 rounded bg-emerald-50 text-emerald-700 border border-emerald-200';
    } else {
      availText.textContent = 'Offline';
      availText.className = 'text-sm font-semibold px-2 py-1 rounded bg-gray-100 text-gray-700 border border-gray-200';
    }
    try {
      const res = await fetch(`${BASE}/api/delivery/availability`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ agent_id: agentId, available })
      });
      if (!res.ok) throw new Error('Failed to update availability');
      const json = await res.json();
      // Optional: small notification
      const msg = available ? 'You are Online' : 'You are Offline';
      const noti = document.createElement('li');
      noti.className = available ? 'bg-green-100 p-3 rounded shadow' : 'bg-gray-100 p-3 rounded shadow';
      noti.textContent = `‚úÖ ${msg}`;
      document.getElementById('notifications').prepend(noti);
    } catch (e) {
      // Revert UI on failure
      toggle.checked = !available;
      window.__isAvailable = toggle.checked;
      if (toggle.checked) {
        availText.textContent = 'Online';
        availText.className = 'text-sm font-semibold px-2 py-1 rounded bg-emerald-50 text-emerald-700 border border-emerald-200';
      } else {
        availText.textContent = 'Offline';
        availText.className = 'text-sm font-semibold px-2 py-1 rounded bg-gray-100 text-gray-700 border border-gray-200';
      }
      alert('Failed to update availability');
      console.error(e);
    }
  });

  // ===== Fullscreen Map for current/selected order =====
  const fullModal = document.createElement('div');
  fullModal.id = 'deliveryFullMapModal';
  fullModal.className = 'fixed inset-0 bg-black/70 hidden items-center justify-center z-[9998]';
  fullModal.innerHTML = `
    <div class="relative bg-white w-[95vw] h-[90vh] rounded-xl overflow-hidden shadow-2xl">
      <button id="deliveryFullMapClose" class="absolute right-3 top-3 z-[9999] bg-white/90 hover:bg-white text-gray-700 rounded-full w-9 h-9 flex items-center justify-center shadow" title="Close">√ó</button>
      <div class="absolute left-3 top-3 z-[9999] bg-white/90 rounded-lg px-3 py-2 text-sm text-gray-700 shadow">
        <div class="space-y-1">
          <div><span class="font-semibold">Order:</span> <span id="delInfoOrder">‚Äî</span></div>
          <div><span class="font-semibold">Restaurant:</span> <span id="delInfoRestaurant">‚Äî</span></div>
          <div><span class="font-semibold">User Phone:</span> <span id="delInfoPhone">‚Äî</span></div>
        </div>
      </div>
      <div id="deliveryFullMap" class="w-full h-full"></div>
    </div>`;
  document.body.appendChild(fullModal);

  let deliveryFullMap; let deliveryFullLayers = [];
  let cachedRestaurants = new Map();

  document.getElementById('btnFullMapDelivery').addEventListener('click', async ()=>{
    // Fetch my current orders and pick the first one
    try{
      const res = await fetch(`${BASE}/api/delivery/${agentId}/orders`);
      const orders = res.ok ? await res.json() : [];
      const ord = orders[0] || null;
      openDeliveryFullMap(ord);
    }catch(e){ openDeliveryFullMap(null); }
  });

  function openDeliveryFullMap(order){
    fullModal.classList.remove('hidden'); fullModal.classList.add('flex');
    const closeBtn = document.getElementById('deliveryFullMapClose');
    if(!deliveryFullMap){
      deliveryFullMap = new mappls.Map('deliveryFullMap', { center: [lastAgentLat, lastAgentLng], zoom: 13 });
    }
    drawDeliveryRoute(order);
    closeBtn.onclick = ()=>{ fullModal.classList.add('hidden'); fullModal.classList.remove('flex'); };
    fullModal.addEventListener('click', (e)=>{ if(e.target === fullModal) closeBtn.click(); });
  }

  function clearDeliveryRoute(){
    deliveryFullLayers.forEach(l => {
      try{
        if (typeof l.setMap === 'function') l.setMap(null);
        else if (typeof l.remove === 'function') l.remove();
      }catch(_){ }
    });
    deliveryFullLayers = [];
  }

  async function getMapplsToken(){
    if (mapplsToken) return mapplsToken;
    try{
      const res = await fetch(`${BASE}/api/mappls/token`);
      if(!res.ok) throw new Error('token request failed');
      const data = await res.json();
      mapplsToken = data.access_token || data.token || null;
      return mapplsToken;
    } catch(e){ console.error('Failed to get Mappls token:', e.message); return null; }
  }

  async function getRestaurant(rid) {
  const id = Number(rid);
  if (cachedRestaurants.has(id)) return cachedRestaurants.get(id);

  try {
    // Fetch all restaurants once (cacheable)
    const res = await fetch(`${BASE}/api/restaurants`);
    const arr = res.ok ? await res.json() : [];

    arr.forEach(r => {
      // ‚úÖ Normalize both possible column names
      const normalized = {
        ...r,
        lat: r.lat ?? r.latitude ?? null,
        lng: r.lng ?? r.longitude ?? null
      };
      cachedRestaurants.set(Number(r.id), normalized);
    });

    return cachedRestaurants.get(id) || null;
  } catch (err) {
    console.error('getRestaurant error:', err);
    return null;
  }
}


async function drawDeliveryRoute(order) {
  try {
    if (!order) return console.warn("‚ö†Ô∏è No active order to draw route");

    // üß† Extract user & restaurant IDs
    const rid = Number(order.restaurant_id);
    const userLat = Number(order.delivery_lat);
    const userLng = Number(order.delivery_lng);
    const agentId = Number(order.agent_id || order.agentId);

    // üè™ Fetch restaurant data (cached)
    const restaurant = await getRestaurant(rid);
    if (!restaurant) {
      showToast(`Restaurant #${rid} not found`, false);
      return;
    }

    // Normalize restaurant coords
    const rlat = Number(restaurant.lat);
    const rlng = Number(restaurant.lng);

    // Validate coordinates
    if (!Number.isFinite(userLat) || !Number.isFinite(userLng)) {
      showToast("User delivery location not available", false);
      return;
    }
    if (!Number.isFinite(rlat) || !Number.isFinite(rlng)) {
      showToast(`Restaurant #${rid} has no coordinates yet. Please set it from Admin Dashboard.`, false);
      return;
    }

    // üîÑ Clear old route layers
    if (window.deliveryMapLayers && Array.isArray(window.deliveryMapLayers)) {
      window.deliveryMapLayers.forEach(l => {
        try {
          if (typeof l.remove === "function") l.remove();
          else if (typeof l.setMap === "function") l.setMap(null);
        } catch (_) {}
      });
    }
    window.deliveryMapLayers = [];

    // üó∫Ô∏è Initialize Map if needed
    if (!window.deliveryMap) {
      window.deliveryMap = new mappls.Map("deliveryFullMap", {
        center: [rlat, rlng],
        zoom: 13
      });
    }
    const map = window.deliveryMap;

    // üö¥ Add agent marker if available
    if (deliveryAgentMarker && typeof deliveryAgentMarker.setPosition === "function") {
      deliveryAgentMarker.setPosition([agentLat, agentLng]);
    }

    // Add Restaurant + Customer markers
    const restMarker = new mappls.Marker({
      map,
      position: [rlat, rlng],
      popupHtml: `üçΩÔ∏è ${restaurant.name} (#${rid})`
    });
    const userMarker = new mappls.Marker({
      map,
      position: [userLat, userLng],
      popupHtml: "üè† Customer Location"
    });

    window.deliveryMapLayers.push(restMarker, userMarker);

    // üöó Draw Mappls Route
    const routeUrl = `https://apis.mappls.com/advancedmaps/v1/522d3498e3667eac0fc7f509c00ac75a/route_adv/driving/${rlng},${rlat};${userLng},${userLat}?geometries=geojson`;

    const res = await fetch(routeUrl);
    const data = await res.json();

    const coords = data?.routes?.[0]?.geometry?.coordinates?.map(c => [c[1], c[0]]);
    if (!coords?.length) return showToast("Failed to get route path", false);

    const route = new mappls.Polyline({
      map,
      path: coords,
      strokeColor: "#16a34a",
      strokeWeight: 6,
      strokeOpacity: 1
    });
    window.deliveryMapLayers.push(route);

    // üö¶ Adjust map view to fit everything
    const allLats = [rlat, userLat];
    const allLngs = [rlng, userLng];
    const minLat = Math.min(...allLats);
    const maxLat = Math.max(...allLats);
    const minLng = Math.min(...allLngs);
    const maxLng = Math.max(...allLngs);

    map.fitBounds([[minLat, minLng], [maxLat, maxLng]]);

    // üïì ETA Display (optional)
    const etaMins = Math.round((data.routes[0].duration || 0) / 60);
    const infoBox = document.getElementById("deliveryRouteInfo");
    if (infoBox) infoBox.innerHTML = `
      <div class="text-gray-700">
        <b>ETA:</b> ${etaMins} min<br>
        <b>Restaurant:</b> ${restaurant.name}<br>
        <b>Customer:</b> ${order.customer_name || "User"}
      </div>
    `;

  } catch (err) {
    console.error("drawDeliveryRoute error:", err);
    showToast("Error drawing delivery route", false);
  }
}
// Removed stray/invalid ETA lines that referenced out-of-scope variables and caused runtime errors

</script>
</body>
</html>
