<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tindo Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Mappls Advanced Maps SDK (unified key) -->
  <script src="https://apis.mappls.com/advancedmaps/api/522d3498e3667eac0fc7f509c00ac75a/map_sdk?v=3.0&layer=vector"></script>
  <script src="js/wish.js" defer></script>
  
  <style>
    /* üî• Universal button animation (CTC style) */
    button {
      transition: all 0.15s ease;
      position: relative;
      overflow: hidden;
    }
    button:active {
      transform: scale(0.95);
    }
    button::after {
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.4s ease, height 0.4s ease;
    }
    button:active::after {
      width: 150%;
      height: 150%;
    }
    
    /* üîî Toast notifications */
    #toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #22c55e;
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s, transform 0.3s;
      z-index: 9999;
    }
    #toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body class="bg-green-50 text-gray-900">

<!-- Navbar -->
<header class="bg-white shadow sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-green-600">üõ†Ô∏è Tindo Admin</h1>
    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg">Logout</button>
  </div>
</header>

<!-- Dashboard -->
<section class="max-w-7xl mx-auto p-6">
  <h2 class="text-3xl font-bold text-green-600 mb-6">üìä Admin Dashboard</h2>

  <!-- Stats -->
  <div class="grid md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white p-4 rounded-xl shadow text-center">
      <h3 class="font-bold">Total Users</h3>
      <p id="totalUsers" class="text-2xl text-green-600">0</p>
    </div>
    <div class="bg-white p-4 rounded-xl shadow text-center">
      <h3 class="font-bold">Total Restaurants</h3>
      <p id="totalRestaurants" class="text-2xl text-green-600">0</p>
    </div>
    <div class="bg-white p-4 rounded-xl shadow text-center">
      <h3 class="font-bold">Total Orders</h3>
      <p id="totalOrders" class="text-2xl text-green-600">0</p>
    </div>
  </div>

  <!-- üìä Analytics -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <h3 class="text-xl font-bold mb-4">üìà Platform Analytics</h3>
    <div class="grid md:grid-cols-2 gap-6">
      <div class="card bg-green-50 p-4 rounded shadow">
        <h4 class="font-bold mb-2">Orders Growth</h4>
        <canvas id="ordersChart"></canvas>
      </div>
      <div class="card bg-green-50 p-4 rounded shadow">
        <h4 class="font-bold mb-2">Revenue Growth</h4>
        <canvas id="revenueChart"></canvas>
      </div>
    </div>
  </div>

  <!-- üè™ Restaurant Approvals -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <h3 class="text-xl font-bold mb-4">üè™ Pending Restaurants</h3>
    <div id="pendingRestaurants" class="space-y-3"></div>
  </div>

  <!-- üö¥ Pending Delivery Agents -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-bold">üö¥ Pending Delivery Agents</h3>
      <label class="text-sm text-gray-600 flex items-center gap-2">
        View:
        <select id="pendingAgentFilter" class="border rounded px-2 py-1 text-sm">
          <option value="pending" selected>Pending only</option>
          <option value="all">All</option>
        </select>
      </label>
    </div>
    <div id="pendingAgents" class="space-y-3"></div>
  </div>

  <!-- üçΩÔ∏è All Menu Items -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <h3 class="text-xl font-bold mb-4">üçΩÔ∏è All Menu Items</h3>
    <div id="adminMenuList" class="grid md:grid-cols-3 gap-6"></div>
  </div>

  <!-- üö¥ Delivery Boys List -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-bold">üö¥ Delivery Boys</h3>
      <label class="text-sm text-gray-600 flex items-center gap-2">
        View:
        <select id="agentFilter" class="border rounded px-2 py-1 text-sm">
          <option value="active" selected>Active only</option>
          <option value="all">All</option>
        </select>
      </label>
    </div>
    <div id="deliveryList" class="space-y-3"></div>
  </div>

  <!-- üìç Delivery Boys Location Map -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-bold">üìç Delivery Boys Location</h3>
  <button id="btnFullMapAdmin" data-wish class="text-gray-700 hover:text-green-700 border px-3 py-1 rounded flex items-center gap-2" title="Fullscreen Map">‚§¢ Fullscreen</button>
    </div>
    <div class="mb-3 flex items-center gap-3">
      <label class="text-sm font-medium">Set restaurant location (enter ID):</label>
      <input id="restaurantIdInput" type="number" min="1" placeholder="Enter restaurant ID" class="border rounded px-3 py-2 text-sm w-48" />
      <button id="btnClearRestaurantMarker" class="ml-2 text-sm px-3 py-1 bg-gray-100 rounded">Clear marker</button>
      <div class="text-xs text-gray-500 ml-4">Enter a restaurant ID, then click the map to place a marker. Drag the marker to refine location.</div>
    </div>
    <div id="map" style="height:400px;" class="rounded relative"></div>
  </div>

  <!-- üì¶ Active Orders -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <h3 class="text-xl font-bold mb-4">üì¶ Active Orders</h3>
    <div id="activeOrders" class="space-y-3"></div>
  </div>

  <!-- üñºÔ∏è Homepage Popup Banner Management -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <h3 class="text-xl font-bold mb-4">üñºÔ∏è Homepage Popup Banner</h3>
    <div class="mb-4 p-4 bg-green-50 rounded-xl">
      <h4 class="font-semibold text-green-800 mb-3">Upload New Banner</h4>
      <form id="bannerForm" class="flex items-end gap-4">
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-2">Banner Image</label>
          <input type="file" id="bannerFile" accept="image/*" class="w-full px-3 py-2 border rounded-lg" required />
          <p class="text-xs text-gray-500 mt-1">Recommended: 1200x600px JPG/PNG</p>
        </div>
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">Upload</button>
      </form>
    </div>
    <div>
      <h4 class="font-semibold text-gray-800 mb-3">Existing Banners</h4>
      <div id="bannersList" class="grid md:grid-cols-3 gap-4"></div>
    </div>
  </div>

    <!-- ‚≠ê Top Restaurants Management -->
    <div class="bg-white p-6 rounded-xl shadow mb-6">
      <h3 class="text-xl font-bold mb-4">‚≠ê Top Restaurants (Homepage Section)</h3>
      <!-- Add Top Restaurant -->
      <div class="mb-6 p-4 bg-green-50 rounded-xl">
        <h4 class="font-semibold text-green-800 mb-3">Add Restaurant to Top List</h4>
        <div class="flex gap-4 items-end">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-2">Restaurant ID</label>
            <input type="number" id="topRestaurantId" placeholder="Enter Restaurant ID" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div class="w-24">
            <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
            <input type="number" id="topPosition" placeholder="1" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <button onclick="addTopRestaurant()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg">Add Top</button>
        </div>
        <h4 class="font-semibold text-green-800 mb-3 mt-6">Control Top Restaurants</h4>
        <div id="topRestaurantsList" class="space-y-3">
          <!-- Dynamic content will be loaded here -->
        </div>
      </div>
    </div>
  
  <!-- üåü Featured Restaurants Management -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <h3 class="text-xl font-bold mb-4">üåü Featured Restaurants (Homepage Banner)</h3>
    
    <!-- Add Featured Restaurant -->
    <div class="mb-6 p-4 bg-green-50 rounded-xl">
      <h4 class="font-semibold text-green-800 mb-3">Add Restaurant to Featured List</h4>
      <div class="flex gap-4 items-end">
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-2">Restaurant ID</label>
          <input type="number" id="featuredRestaurantId" placeholder="Enter Restaurant ID" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div class="w-24">
          <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
          <input type="number" id="featuredPosition" placeholder="1" min="1" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <button onclick="addFeaturedRestaurant()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg">
          Add Featured
        </button>
      </div>
    </div>

    <!-- Current Featured Restaurants -->
    <div>
      <h4 class="font-semibold text-gray-800 mb-3">Current Featured Restaurants</h4>
      <div id="featuredRestaurantsList" class="space-y-3">
        <!-- Dynamic content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- üì¢ Notifications -->
  <div class="bg-white p-6 rounded-xl shadow">
    <h3 class="text-xl font-bold mb-4">üîî Notifications</h3>
    <ul id="notifications" class="space-y-2"></ul>
  </div>
</section>

<!-- Toast notification -->
<div id="toast"></div>

<!-- üó∫Ô∏è Fullscreen Map Modal -->
<div id="adminFullMapModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-[9998]">
  <div class="relative bg-white w-[95vw] h-[90vh] rounded-xl overflow-hidden shadow-2xl">
    <button id="adminFullMapClose" class="absolute right-3 top-3 z-[9999] bg-white/90 hover:bg-white text-gray-700 rounded-full w-9 h-9 flex items-center justify-center shadow" title="Close">√ó</button>
    <div class="absolute left-3 top-3 z-[9999] bg-white/90 rounded-lg px-3 py-2 text-sm text-gray-700 shadow">
      <div id="adminRouteInfo" class="space-y-1">
        <div><span class="font-semibold">Order:</span> <span id="adminInfoOrder">‚Äî</span></div>
        <div><span class="font-semibold">Restaurant:</span> <span id="adminInfoRestaurant">‚Äî</span></div>
        <div><span class="font-semibold">User Phone:</span> <span id="adminInfoPhone">‚Äî</span></div>
      </div>
    </div>
    <div id="adminFullMap" class="w-full h-full"></div>
  </div>
  
</div>

<script>
const BASE = "https://food-delivery-backend-cw3m.onrender.com";
const socket = io(BASE);

// When socket connects, ensure map is seeded with restaurants and current delivery agents
socket.on('connect', () => {
  console.log('Socket connected ‚Äî seeding map data');
  try { loadDeliveryBoys(); } catch(_) {}
  try { loadRestaurantsForMap(); } catch(_) {}
});

// ‚úÖ Auth check - ADMIN ONLY
const user = JSON.parse(localStorage.getItem("user") || "{}");
const token = localStorage.getItem("token");

// Validate user is admin
if (!user || user.role !== "admin") {
  console.warn("‚ùå Not an admin user. Redirecting...", user);
  alert("Admin access required!");
  window.location.href = "login.html";
}

// Validate token structure and expiration
if (token) {
  try {
    const payload = JSON.parse(atob(token.split(".")[1]));
    const isExpired = payload.exp * 1000 < Date.now();

    if (isExpired) {
      console.warn("‚è∞ Token expired");
      alert("Session expired. Please login again.");
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "login.html";
    }
  } catch (err) {
    console.error("‚ùå Invalid token format:", err);
    alert("Invalid session. Please login again.");
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    window.location.href = "login.html";
  }
} else {
  console.warn("‚ö†Ô∏è No token found");
  alert("Unauthorized! Please login again.");
  window.location.href = "login.html";
}

// ‚úÖ Toast function
function showToast(message, success = true) {
  let toast = document.getElementById("toast");
  toast.style.background = success ? "#22c55e" : "#ef4444";
  toast.textContent = message;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 3000);
}

// ‚úÖ Centralized API helper with error handling
async function apiCall(endpoint, options = {}) {
  try {
    const defaultHeaders = {
      "Content-Type": "application/json",
      ...(token && { Authorization: `Bearer ${token}` })
    };
    
    const response = await fetch(`${BASE}${endpoint}`, {
      ...options,
      headers: { ...defaultHeaders, ...options.headers }
    });

    // Read response text first
    const text = await response.text();
    let data = {};
    
    // Try to parse JSON only if we have text and it looks like JSON
    if (text && text.trim()) {
      try {
        data = JSON.parse(text);
      } catch (jsonErr) {
        // If parse fails and response is not OK, it's likely an HTML error page
        if (!response.ok) {
          console.error(`‚ùå Non-JSON error response [${response.status}] ${endpoint}`);
          return { success: false, error: `Server error: ${response.status}` };
        }
        console.warn(`‚ö†Ô∏è Failed to parse JSON from ${endpoint}:`, text.substring(0, 100));
      }
    }

    if (!response.ok) {
      console.error(`‚ùå API Error [${response.status}] ${endpoint}:`, data);
      return { success: false, error: data.error || data.message || `HTTP ${response.status}` };
    }

    // Normalize response: if data is already { success, data }, return as-is
    // Otherwise wrap it
    if (data && typeof data === 'object' && 'success' in data) {
      return data;
    }
    
    return { success: true, data, status: response.status };
  } catch (err) {
    console.error(`‚ùå Network error on ${endpoint}:`, err);
    return { success: false, error: err.message };
  }
}

// ‚úÖ Toast function
function showToast(message, success = true) {
  let toast = document.getElementById("toast");
  if (!toast) return console.log(`[${success ? "‚úÖ" : "‚ùå"}] ${message}`);
  
  toast.style.background = success ? "#22c55e" : "#ef4444";
  toast.textContent = message;
  toast.classList.add("show");
  
  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}

// ===== STATS FUNCTIONS =====
async function loadStats() {
  console.log("üìä Loading stats...");
  
  // Users count
  const usersRes = await apiCall("/api/admin/users/count");
  if (usersRes.success) {
    document.getElementById("totalUsers").textContent = usersRes.data?.count ?? 0;
  } else {
    console.warn("Users count failed, trying fallback...");
    const fallbackRes = await apiCall("/api/admin/users");
    if (fallbackRes.success) {
      document.getElementById("totalUsers").textContent = Array.isArray(fallbackRes.data) ? fallbackRes.data.length : 0;
    } else {
      document.getElementById("totalUsers").textContent = 0;
    }
  }

  // Restaurants count
  const restRes = await apiCall("/api/admin/restaurants/count");
  if (restRes.success) {
    document.getElementById("totalRestaurants").textContent = restRes.data?.count ?? 0;
  } else {
    const fallbackRes = await apiCall("/api/admin/restaurants");
    if (fallbackRes.success) {
      document.getElementById("totalRestaurants").textContent = Array.isArray(fallbackRes.data) ? fallbackRes.data.length : 0;
    } else {
      document.getElementById("totalRestaurants").textContent = 0;
    }
  }

  // Orders count
  const ordersRes = await apiCall("/api/admin/orders/count");
  if (ordersRes.success) {
    document.getElementById("totalOrders").textContent = ordersRes.data?.count ?? 0;
  } else {
    const fallbackRes = await apiCall("/api/admin/orders");
    if (fallbackRes.success) {
      document.getElementById("totalOrders").textContent = Array.isArray(fallbackRes.data) ? fallbackRes.data.length : 0;
    } else {
      document.getElementById("totalOrders").textContent = 0;
    }
  }
  
  console.log("‚úÖ Stats loaded");
}

// ===== PENDING RESTAURANTS FUNCTIONS =====
async function loadPendingRestaurants() {
  console.log("üè™ Loading pending restaurants...");
  
  const res = await apiCall("/api/admin/restaurants");
  if (!res.success) {
    showToast(`Failed to load restaurants: ${res.error}`, false);
    return;
  }

  const list = document.getElementById("pendingRestaurants");
  const pending = res.data.filter(r => (r.status || "").toLowerCase() === "pending");

  if (!pending.length) {
    list.innerHTML = `<p class="text-gray-500">‚úì No pending approvals</p>`;
    return;
  }

  list.innerHTML = pending.map(r => `
    <div class="card bg-green-50 p-4 rounded-xl shadow flex justify-between items-center">
      <div>
        <h3 class="font-bold">${r.name}</h3>
        <p class="text-sm text-gray-500">${r.email || "N/A"}</p>
      </div>
      <div class="flex gap-2">
        <button onclick="approveRestaurant(${r.id})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg">‚úÖ Approve</button>
        <button onclick="rejectRestaurant(${r.id})" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg">‚ùå Reject</button>
      </div>
    </div>
  `).join("");
  
  console.log(`‚úÖ Loaded ${pending.length} pending restaurants`);
}

async function approveRestaurant(id) {
  try {
    console.log(`‚úÖ Approving restaurant ${id}...`);
    
    const res = await apiCall(`/api/admin/restaurants/approve/${id}`, {
      method: "PUT"
    });

    if (res.success) {
      showToast(`‚úÖ Restaurant #${id} approved`);
      await loadPendingRestaurants();
      await loadStats();
    } else {
      showToast(`Failed to approve: ${res.error}`, false);
    }
  } catch (err) {
    console.error("Approve error:", err);
    showToast(`Error: ${err.message}`, false);
  }
}

async function rejectRestaurant(id) {
  try {
    console.log(`‚ùå Rejecting restaurant ${id}...`);
    
    const res = await apiCall(`/api/admin/restaurants/reject/${id}`, {
      method: "PUT"
    });

    if (res.success) {
      showToast(`‚ùå Restaurant #${id} rejected`);
      await loadPendingRestaurants();
      await loadStats();
    } else {
      showToast(`Failed to reject: ${res.error}`, false);
    }
  } catch (err) {
    console.error("Reject error:", err);
    showToast(`Error: ${err.message}`, false);
  }
}

// ===== PENDING DELIVERY AGENTS =====
async function loadPendingAgents() {
  console.log("üö¥ Loading pending delivery agents...");

  const sel = document.getElementById("pendingAgentFilter");
  const isAll = sel && sel.value === "all";

  const endpoint = isAll ? "/api/admin/agents" : "/api/admin/agents/pending";
  const res = await apiCall(endpoint);
  if (!res.success) {
    showToast(`Failed to load agents: ${res.error}`, false);
    return;
  }

  const list = document.getElementById("pendingAgents");
  const agents = Array.isArray(res.data?.data) ? res.data.data : Array.isArray(res.data) ? res.data : [];

  if (!agents.length) {
    list.innerHTML = `<p class="text-gray-500">${isAll ? "No agents found" : "‚úì No pending agents"}</p>`;
    return;
  }

  list.innerHTML = agents.map(a => {
    const isActive = (a.status || "").toLowerCase() === "active";
    const statusCls = isActive ? "bg-green-100 text-green-800" : "bg-gray-100 text-gray-700";
    const statusLabel = a.status || (isActive ? "Active" : "Inactive");
    const actions = isAll
      ? (isActive
          ? `<button onclick="deactivateAgent(${a.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg">‚è∏Ô∏è Deactivate</button>`
          : `<button onclick="approveAgent(${a.id})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg">‚úÖ Activate</button>`)
      : `<button onclick="approveAgent(${a.id})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg">‚úÖ Activate</button>`;

    return `
    <div class="card bg-green-50 p-4 rounded-xl shadow flex justify-between items-center">
      <div>
        <h3 class="font-bold">${a.name}</h3>
        <p class="text-sm text-gray-500">${a.phone || "N/A"}${a.email ? ` | ${a.email}` : ""}</p>
        <p class="text-xs text-gray-500">Vehicle: ${a.vehicle_type || "N/A"}${a.aadhar ? ` | Aadhaar: ${a.aadhar}` : ""}</p>
        <span class="inline-block px-2 py-1 text-xs rounded-full ${statusCls}">${statusLabel}</span>
      </div>
      <div class="flex gap-2">
        ${actions}
      </div>
    </div>
    `;
  }).join("");

  console.log(`‚úÖ Loaded ${agents.length} ${isAll ? "agents" : "pending agents"}`);
}

// ===== ALL MENU ITEMS =====
async function loadAllMenu() {
  console.log("üçΩÔ∏è Loading all menu items...");
  
  const res = await apiCall("/api/admin/menu");
  if (!res.success) {
    console.warn("Admin menu endpoint not found, trying fallback...");
    // Fallback: fetch from each restaurant (slower but works)
    const restRes = await apiCall("/api/admin/restaurants");
    if (!restRes.success) {
      document.getElementById("adminMenuList").innerHTML = `<p class="text-gray-500">Failed to load menu</p>`;
      return;
    }
    
    let allItems = [];
    for (const rest of restRes.data) {
      const menuRes = await apiCall(`/api/menu/restaurant/${rest.id}`);
      if (menuRes.success) {
        allItems = allItems.concat(menuRes.data);
      }
    }
    
    renderMenuItems(allItems);
    return;
  }

  renderMenuItems(res.data || []);
  console.log(`‚úÖ Loaded ${res.data?.length || 0} menu items`);
}

function renderMenuItems(items) {
  const list = document.getElementById("adminMenuList");
  if (!items.length) {
    list.innerHTML = `<p class="text-gray-500">No menu items found</p>`;
    return;
  }

  list.innerHTML = items.map(m => {
    const builtUrl = m.image_url ? `${BASE}/uploads/menu/${m.image_url}` : null;
    const imgSrc = m.image_url_full || builtUrl;
    return `
    <div class="card bg-green-50 p-4 rounded-xl shadow hover:shadow-lg transition-shadow">
      ${imgSrc ? `<img src="${imgSrc}" class="h-32 w-full object-cover rounded mb-3" alt="${m.item_name}">` : `<div class="h-32 w-full bg-gray-200 rounded mb-3 flex items-center justify-center text-gray-500">No image</div>`}
      <h3 class="font-bold text-lg">${m.item_name}</h3>
      <p class="text-sm text-gray-600 truncate">${m.description || "No description"}</p>
      <p class="text-green-600 font-semibold mt-2">‚Çπ${m.price}</p>
      <p class="text-xs text-gray-500 mt-1">Restaurant: ${m.restaurant_name || m.restaurant_id}</p>
    </div>
  `}).join("");
}

// ===== DELIVERY BOYS =====
async function loadDeliveryBoys() {
  console.log("üö¥ Loading delivery boys...");
  
  const sel = document.getElementById("agentFilter");
  const isAll = sel && sel.value === "all";
  const endpoint = isAll ? "/api/admin/delivery?all=true" : "/api/admin/delivery";
  
  const res = await apiCall(endpoint);
  if (!res.success) {
    console.error("Delivery fetch failed, trying fallback...");
    // Fallback
    const altRes = await apiCall("/api/admin/agents");
    if (!altRes.success) {
      document.getElementById("deliveryList").innerHTML = `<p class="text-gray-500">Failed to load delivery agents</p>`;
      return;
    }
    renderDeliveryBoys(altRes.data || []);
    return;
  }

  renderDeliveryBoys(res.data || []);
  console.log(`‚úÖ Loaded ${res.data?.length || 0} delivery agents`);
}

function renderDeliveryBoys(agents) {
  const list = document.getElementById("deliveryList");
  const sel = document.getElementById("agentFilter");
  const isAll = sel && sel.value === "all";

  if (!agents.length) {
    list.innerHTML = `<p class="text-gray-500">${isAll ? "No agents found" : "No active agents"}</p>`;
    return;
  }

  // Filter active if needed
  const filtered = isAll ? agents : agents.filter(d => (d.status || "").toLowerCase() === "active");

  list.innerHTML = filtered.map(d => {
    const isActive = (d.status || "").toLowerCase() === "active";
    const statusCls = isActive ? "bg-green-100 text-green-800" : "bg-gray-100 text-gray-700";
    const statusLabel = d.status || (isActive ? "Active" : "Inactive");
    return `
    <div class="card bg-green-50 p-4 rounded-xl shadow flex justify-between items-center">
      <div>
        <h3 class="font-bold">${d.name}</h3>
        <p class="text-sm text-gray-600">${d.email || "N/A"} | ${d.phone || "N/A"}</p>
        <span class="inline-block px-2 py-1 text-xs rounded-full ${statusCls}">${statusLabel}</span>
      </div>
      <div class="flex gap-2">
        ${isActive
          ? `<button onclick="deactivateAgent(${d.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 shadow-md hover:shadow-lg">‚è∏Ô∏è Deactivate</button>`
          : `<button onclick="approveAgent(${d.id})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 shadow-md hover:shadow-lg">‚úÖ Activate</button>`}
      </div>
    </div>
    `;
  }).join("");

  // Seed map markers
  clearAllAgentMarkers();
  agents.forEach(d => {
    const lat = Number(d.lat);
    const lng = Number(d.lng);
    if (Number.isFinite(lat) && Number.isFinite(lng)) {
      const label = `${d.name} (#${d.id})${d.current_order_id ? ` ‚Äî Order #${d.current_order_id}` : ""}`;
      ensureInitMapAndMarker(d.id, lat, lng, label);
    }
  });
}

// ===== DELIVERY AGENT ACTIONS =====
async function approveAgent(id) {
  try {
    const res = await apiCall(`/api/admin/agents/approve/${id}`, { method: "PUT" });
    if (res.success) {
      showToast(`‚úÖ Agent #${id} activated`);
      await loadDeliveryBoys();
    } else {
      showToast(`Failed to activate agent: ${res.error}`, false);
    }
  } catch (err) {
    console.error("Approve agent error:", err);
    showToast(`Error: ${err.message}`, false);
  }
}

async function deactivateAgent(id) {
  try {
    const res = await apiCall(`/api/admin/agents/deactivate/${id}`, { method: "PUT" });
    if (res.success) {
      showToast(`‚è∏Ô∏è Agent #${id} deactivated`);
      await loadDeliveryBoys();
    } else {
      showToast(`Failed to deactivate agent: ${res.error}`, false);
    }
  } catch (err) {
    console.error("Deactivate agent error:", err);
    showToast(`Error: ${err.message}`, false);
  }
}

// ===== ACTIVE ORDERS =====
async function loadActiveOrders() {
  console.log("üì¶ Loading active orders...");
  
  const res = await apiCall("/api/admin/orders");
  if (!res.success) {
    showToast(`Failed to load orders: ${res.error}`, false);
    return;
  }

  renderActiveOrders(res.data || []);
  console.log(`‚úÖ Loaded ${res.data?.length || 0} active orders`);
}

function renderActiveOrders(orders) {
  const list = document.getElementById("activeOrders");
  
  if (!orders.length) {
    list.innerHTML = `<p class="text-gray-500">No active orders</p>`;
    return;
  }

  list.innerHTML = orders.map(o => {
    let itemsText = "N/A";
    try {
      if (typeof o.items === "string") {
        const parsed = JSON.parse(o.items);
        itemsText = Array.isArray(parsed) ? parsed.map(i => i.name || i.item_name).join(", ") : o.items;
      }
    } catch (_) {
      itemsText = o.items || "N/A";
    }

    return `
      <div class="card bg-green-50 p-4 rounded-xl shadow">
        <div class="flex justify-between items-start mb-3">
          <div>
            <p class="font-bold">Order #${o.id}</p>
            <p class="text-sm text-gray-600">Items: ${itemsText}</p>
          </div>
          <span class="px-2 py-1 text-xs font-semibold rounded ${getStatusColor(o.status)}">${o.status || "Unknown"}</span>
        </div>
        <p class="text-sm text-gray-600 mb-3">Delivery to: ${o.delivery_address || "N/A"}</p>
        <button onclick="assignAgent(${o.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
          ü§ñ Auto-Assign Agent
        </button>
      </div>
    `;
  }).join("");
}

function getStatusColor(status) {
  const statusMap = {
    "pending": "bg-yellow-100 text-yellow-800",
    "confirmed": "bg-blue-100 text-blue-800",
    "preparing": "bg-purple-100 text-purple-800",
    "ready": "bg-indigo-100 text-indigo-800",
    "picked_up": "bg-cyan-100 text-cyan-800",
    "delivered": "bg-green-100 text-green-800",
    "cancelled": "bg-red-100 text-red-800"
  };
  return statusMap[status?.toLowerCase()] || "bg-gray-100 text-gray-800";
}

async function assignAgent(orderId) {
  try {
    console.log(`ü§ñ Auto-assigning agent to order ${orderId}...`);
    
    const res = await apiCall(`/api/admin/orders/${orderId}/assign`, {
      method: "POST"
    });

    if (res.success) {
      showToast(`‚úÖ Agent assigned to order #${orderId}`);
      await loadActiveOrders();
      await loadStats();
    } else {
      showToast(`Failed to assign: ${res.error}`, false);
    }
  } catch (err) {
    console.error("Assign error:", err);
    showToast(`Error: ${err.message}`, false);
  }
}

// ===== FEATURED & TOP RESTAURANTS =====
async function loadFeaturedRestaurants() {
  console.log("üåü Loading featured restaurants...");
  
  const res = await apiCall("/api/admin/featured-restaurants");
  if (!res.success) {
    console.warn("Featured restaurants failed:", res.error);
    document.getElementById("featuredRestaurantsList").innerHTML = `<p class="text-gray-500">Failed to load featured restaurants</p>`;
    return;
  }

  renderFeaturedRestaurants(res.data || []);
  console.log(`‚úÖ Loaded ${res.data?.length || 0} featured restaurants`);
}

function renderFeaturedRestaurants(restaurants) {
  const list = document.getElementById("featuredRestaurantsList");
  
  if (!restaurants.length) {
    list.innerHTML = `<p class="text-gray-500">No featured restaurants yet</p>`;
    return;
  }

  list.innerHTML = restaurants.map(fr => {
    const img = fr.image_url ? `${BASE}/uploads/${fr.image_url}` : "https://via.placeholder.com/120?text=No+Image";
    return `
    <div class="card bg-green-50 p-4 rounded-xl shadow flex justify-between items-center">
      <div class="flex items-center gap-4">
        <img src="${img}" class="w-16 h-16 rounded object-cover" onerror="this.src='https://via.placeholder.com/120?text=No+Image'" />
        <div>
          <h3 class="font-bold text-gray-800">${fr.name}</h3>
          <p class="text-sm text-gray-600">ID: ${fr.id || fr.restaurant_id} | ${fr.cuisine || "Multi-Cuisine"}</p>
          <span class="inline-block px-2 py-1 text-xs rounded-full ${fr.status === 'approved' ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800"}">
            ${fr.status || "unknown"}
          </span>
        </div>
      </div>
      <div class="flex gap-2">
        <button onclick="toggleFeaturedRestaurant(${fr.id || fr.restaurant_id}, ${fr.featured || 0})" 
          class="px-4 py-2 rounded-lg text-sm font-medium text-white transition-all duration-200 ${fr.featured ? "bg-yellow-500 hover:bg-yellow-600" : "bg-green-600 hover:bg-green-700"}">
          ${fr.featured ? "Deactivate" : "Activate"}
        </button>
        <button onclick="removeFeaturedRestaurant(${fr.id || fr.restaurant_id})" 
          class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
          Remove
        </button>
      </div>
    </div>
  `;}).join("");
}

async function addFeaturedRestaurant() {
  const restaurantId = document.getElementById("featuredRestaurantId").value;
  const position = document.getElementById("featuredPosition").value || 1;

  if (!restaurantId) {
    showToast("Please enter a restaurant ID", false);
    return;
  }

  try {
    const res = await apiCall("/api/admin/featured-restaurants", {
      method: "POST",
      body: JSON.stringify({ restaurant_id: parseInt(restaurantId), position: parseInt(position) })
    });

    if (res.success) {
      showToast("‚úÖ Restaurant added to featured list!");
      document.getElementById("featuredRestaurantId").value = "";
      document.getElementById("featuredPosition").value = "";
      await loadFeaturedRestaurants();
    } else {
      showToast(`Failed: ${res.error}`, false);
    }
  } catch (err) {
    showToast(`Error: ${err.message}`, false);
  }
}

async function removeFeaturedRestaurant(id) {
  if (!confirm("Remove this restaurant from featured list?")) return;

  try {
    const res = await apiCall(`/api/admin/featured-restaurants/${id}`, {
      method: "DELETE"
    });

    if (res.success) {
      showToast("‚úÖ Restaurant removed");
      await loadFeaturedRestaurants();
    } else {
      showToast(`Failed: ${res.error}`, false);
    }
  } catch (err) {
    showToast(`Error: ${err.message}`, false);
  }
}

async function toggleFeaturedRestaurant(id, currentStatus) {
  try {
    const res = await apiCall(`/api/admin/featured-restaurants/${id}/toggle`, {
      method: "PUT"
    });

    if (res.success) {
      showToast(`‚úÖ Restaurant ${res.data?.is_active ? "activated" : "deactivated"}`);
      await loadFeaturedRestaurants();
    } else {
      showToast(`Failed: ${res.error}`, false);
    }
  } catch (err) {
    showToast(`Error: ${err.message}`, false);
  }
}

// ===== TOP RESTAURANTS =====
async function loadTopRestaurants() {
  console.log("‚≠ê Loading top restaurants...");
  
  const res = await apiCall("/api/admin/top-restaurants");
  if (!res.success) {
    console.warn("Top restaurants failed:", res.error);
    document.getElementById("topRestaurantsList").innerHTML = `<p class="text-gray-500">Failed to load top restaurants</p>`;
    return;
  }

  renderTopRestaurants(res.data || []);
  console.log(`‚úÖ Loaded ${res.data?.length || 0} top restaurants`);
}

function renderTopRestaurants(restaurants) {
  const list = document.getElementById("topRestaurantsList");
  
  if (!restaurants.length) {
    list.innerHTML = `<p class="text-gray-500">No top restaurants yet</p>`;
    return;
  }

  list.innerHTML = restaurants.map(tr => {
    const img = tr.image_url ? `${BASE}/uploads/${tr.image_url}` : "https://via.placeholder.com/120?text=No+Image";
    return `
    <div class="card bg-blue-50 p-4 rounded-xl shadow flex justify-between items-center">
      <div class="flex items-center gap-4">
        <img src="${img}" class="w-16 h-16 rounded object-cover" onerror="this.src='https://via.placeholder.com/120?text=No+Image'" />
        <div>
          <h3 class="font-bold text-gray-800">${tr.name}</h3>
          <p class="text-sm text-gray-600">ID: ${tr.restaurant_id} | ${tr.cuisine || "Multi-Cuisine"}</p>
          <p class="text-xs text-gray-500">Orders: ${tr.order_count || 0}</p>
          <span class="inline-block px-2 py-1 text-xs rounded-full ${tr.status === 'approved' ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800"}">
            ${tr.status || "unknown"}
          </span>
        </div>
      </div>
      <div class="flex gap-2">
        <button onclick="toggleTopRestaurant(${tr.restaurant_id}, ${tr.is_top || 0})" 
          class="px-4 py-2 rounded-lg text-sm font-medium text-white transition-all duration-200 ${tr.is_top ? "bg-yellow-500 hover:bg-yellow-600" : "bg-blue-600 hover:bg-blue-700"}">
          ${tr.is_top ? "Deactivate" : "Activate"}
        </button>
        <button onclick="removeTopRestaurant(${tr.restaurant_id})" 
          class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
          Remove
        </button>
      </div>
    </div>
  `;}).join("");
}

async function addTopRestaurant() {
  const restaurantId = document.getElementById("topRestaurantId").value;
  const position = document.getElementById("topPosition").value || 1;

  if (!restaurantId) {
    showToast("Please enter a restaurant ID", false);
    return;
  }

  try {
    const res = await apiCall("/api/admin/top-restaurants", {
      method: "POST",
      body: JSON.stringify({ restaurant_id: parseInt(restaurantId), position: parseInt(position) })
    });

    if (res.success) {
      showToast("‚úÖ Restaurant added to top list!");
      document.getElementById("topRestaurantId").value = "";
      document.getElementById("topPosition").value = "";
      await loadTopRestaurants();
    } else {
      showToast(`Failed: ${res.error}`, false);
    }
  } catch (err) {
    showToast(`Error: ${err.message}`, false);
  }
}

async function removeTopRestaurant(id) {
  if (!confirm("Remove this restaurant from top list?")) return;

  try {
    const res = await apiCall(`/api/admin/top-restaurants/${id}`, {
      method: "DELETE"
    });

    if (res.success) {
      showToast("‚úÖ Restaurant removed");
      await loadTopRestaurants();
    } else {
      showToast(`Failed: ${res.error}`, false);
    }
  } catch (err) {
    showToast(`Error: ${err.message}`, false);
  }
}

async function toggleTopRestaurant(id, currentStatus) {
  try {
    const res = await apiCall(`/api/admin/top-restaurants/${id}/toggle`, {
      method: "PUT"
    });

    if (res.success) {
      showToast(`‚úÖ Restaurant ${res.data?.is_active ? "activated" : "deactivated"}`);
      await loadTopRestaurants();
    } else {
      showToast(`Failed: ${res.error}`, false);
    }
  } catch (err) {
    showToast(`Error: ${err.message}`, false);
  }
}

// ===== BANNERS MANAGEMENT =====
async function loadBanners() {
  console.log("üñºÔ∏è Loading banners...");
  
  const res = await apiCall("/api/admin/banners");
  if (!res.success) {
    console.warn("Banners load failed:", res.error);
    return;
  }

  const list = document.getElementById("bannersList");
  if (!list) return;

  if (!res.data || !res.data.length) {
    list.innerHTML = `<p class="text-gray-500">No banners uploaded</p>`;
    return;
  }

  list.innerHTML = res.data.map(b => `
    <div class="relative border rounded-xl overflow-hidden group hover:shadow-lg transition-shadow">
      <img src="${BASE}/uploads/${b.image_url}" class="w-full h-40 object-cover" alt="Banner #${b.id}">
      <button onclick="removeBanner(${b.id})" title="Remove" class="absolute top-2 right-2 bg-white/90 text-gray-700 hover:bg-white rounded-full w-8 h-8 flex items-center justify-center shadow hover:shadow-lg transition-all">√ó</button>
      <div class="absolute bottom-0 left-0 right-0 text-xs text-gray-600 bg-white/80 px-2 py-1 flex justify-between">
        <span>#${b.id}</span>
        <span>${b.is_active ? "‚úì Active" : "Inactive"}</span>
      </div>
    </div>
  `).join("");

  console.log(`‚úÖ Loaded ${res.data.length} banners`);
}

async function removeBanner(id) {
  if (!confirm("Remove this banner?")) return;

  try {
    const res = await apiCall(`/api/admin/banners/${id}`, {
      method: "DELETE"
    });

    if (res.success) {
      showToast("‚úÖ Banner removed");
      await loadBanners();
    } else {
      showToast(`Failed: ${res.error}`, false);
    }
  } catch (err) {
    showToast(`Error: ${err.message}`, false);
  }
}

// ===== FETCH ALL ORDERS =====
async function fetchAllOrders() {
  console.log("üìã Fetching all orders...");
  
  const res = await apiCall("/api/orders");
  if (!res.success) {
    console.warn("Orders fetch failed:", res.error);
    return;
  }

  console.log(`‚úÖ Fetched ${res.data?.length || 0} orders`);
  return res.data;
}

// ===== Delivery Boys Location Map (Mappls) =====
let map; // Mappls map instance for small admin map
let deliveryMarkers = {}; // { agentId: mappls.Marker }
// initialize Mappls map (center uses [lat, lng] in other files but Mappls constructors here accept [lat,lng])
function initAdminMap() {
  if (typeof mappls === 'undefined') {
    console.error('Mappls SDK not loaded.');
    return;
  }
  if (!map) {
    map = new mappls.Map('map', { center: [17.385, 78.486], zoom: 12 });
    // Attach click handler for setting restaurant location (only once)
    try {
      if (!map._hasRestaurantClickHandler) {
        map.on('click', function(e) {
          try {
            const restaurantInput = document.getElementById('restaurantIdInput');
            const restaurant_id = restaurantInput ? restaurantInput.value : null;
            if (!restaurant_id) {
              showToast('Enter a restaurant ID first', false);
              return;
            }
            const lat = Number((e.latlng?.lat ?? e.lat ?? (Array.isArray(e.latlng) ? e.latlng[0] : null))).toFixed(7);
            const lon = Number((e.latlng?.lng ?? e.lng ?? (Array.isArray(e.latlng) ? e.latlng[1] : null))).toFixed(7);
            placeRestaurantMarker(restaurant_id, Number(lat), Number(lon), true);
          } catch (inner) { console.error('Map click handler error', inner); }
        });
        map._hasRestaurantClickHandler = true;
      }
    } catch (err) { console.error('Failed to attach map click handler', err); }
  }
}
let restaurantsById = new Map();
let usersById = new Map();
let adminFullMap; let adminFullMapLayers = [];
let restaurantSavedMarkers = [];

function clearAllAgentMarkers() {
  Object.values(deliveryMarkers).forEach(m => {
    try {
      if (m && typeof m.remove === 'function') m.remove();
      else if (m && typeof m.setMap === 'function') m.setMap(null);
    } catch (_) {}
  });
  deliveryMarkers = {};
}

// Support both legacy 'agentLocation' and new 'locationUpdate' events
// Support both legacy 'agentLocation' and new 'locationUpdate' events and show order number when available
function ensureInitMapAndMarker(id, lat, lng, label) {
  try { initAdminMap(); } catch (_) {}
  if (id == null) return;
  const pos = [lat, lng]; // ‚úÖ FIXED

  if (deliveryMarkers[id]) {
    try {
      // prefer setPosition, fallback to setMap/position APIs
      if (typeof deliveryMarkers[id].setPosition === 'function') deliveryMarkers[id].setPosition(pos);
      else if (typeof deliveryMarkers[id].setLatLng === 'function') deliveryMarkers[id].setLatLng({ lat: pos[0], lng: pos[1] });
      else if (deliveryMarkers[id].setMap) deliveryMarkers[id].setMap(map);
    } catch (_) {}
  } else {
    try {
      const m = new mappls.Marker({ map, position: pos, popupHtml: label || (`Delivery Agent #${id}`) });
      // show popup on hover
      try {
        if (m && typeof m.on === 'function') {
          m.on('mouseover', function(){ try { m.setPopupHtml && m.setPopupHtml(label || (`Delivery Agent #${id}`)); m.openPopup && m.openPopup(); } catch(e){} });
          m.on('mouseout', function(){ try { m.closePopup && m.closePopup(); } catch(e){} });
        }
      } catch(e){}
      deliveryMarkers[id] = m;
    } catch (e) {
      console.error('Failed to create Mappls marker for agent', id, e);
    }
  }
}

// ===== Restaurant location setter helpers =====
let restaurantMarker = null;
let currentRestaurantMarkerId = null;

function clearRestaurantMarker() {
  try {
    if (restaurantMarker && typeof restaurantMarker.remove === 'function') restaurantMarker.remove();
    else if (restaurantMarker && typeof restaurantMarker.setMap === 'function') restaurantMarker.setMap(null);
  } catch (_) {}
  restaurantMarker = null; currentRestaurantMarkerId = null;
}

async function sendRestaurantLocation(restaurant_id, latitude, longitude) {
  try {
    const headers = { 'Content-Type': 'application/json' };
    if (token) headers.Authorization = `Bearer ${token}`;
    const res = await fetch(`${BASE}/api/update-restaurant-location`, {
      method: 'POST',
      headers,
      body: JSON.stringify({ restaurant_id: Number(restaurant_id), latitude: Number(latitude), longitude: Number(longitude) })
    });
    const data = await res.json().catch(()=>({}));
    if (res.ok) {
      showToast(data.message || 'Saved restaurant location');
      // Update local cache
      const r = restaurantsById.get(Number(restaurant_id));
      if (r) { r.lat = Number(latitude); r.lng = Number(longitude); restaurantsById.set(Number(restaurant_id), r); }
      // Visual saved indicator: place a temporary green marker / popup near the saved location
      try {
        if (restaurantMarker) {
          // show a saved popup on the existing draggable marker
          try { restaurantMarker.setPopupHtml && restaurantMarker.setPopupHtml(`<b>Saved ‚úì</b>`); } catch(_) {}
        }
        const savedMk = new mappls.Marker({ map, position: [Number(latitude), Number(longitude)], popupHtml: `<b style="color:green">Saved ‚úì ${r?.name || ''}</b>` });
        setTimeout(() => { try { if (savedMk && typeof savedMk.remove === 'function') savedMk.remove(); } catch(_) {} }, 3000);
      } catch (e) { console.error('Saved indicator error', e); }
    } else {
      console.error('Save location failed', data);
      showToast(data.message || 'Failed to save location', false);
    }
  } catch (err) {
    console.error('sendRestaurantLocation error', err);
    showToast('Network error saving location', false);
  }
}

function placeRestaurantMarker(restaurant_id, lat, lng, send = false) {
  try {
    initAdminMap();
    clearRestaurantMarker();
    if (!Number.isFinite(Number(lat)) || !Number.isFinite(Number(lng))) return;
    const pos = [Number(lat), Number(lng)];
    const restName = (restaurantsById.get(Number(restaurant_id)) || {}).name || '';
    const popupHtml = `<b>${restName ? restName + ' ‚Äî ' : ''}#${restaurant_id}</b>`;
    restaurantMarker = new mappls.Marker({ map, position: pos, draggable: true, popupHtml });
    // show popup on hover (and close on mouseout) if marker supports events
    try {
      if (restaurantMarker && typeof restaurantMarker.on === 'function') {
        restaurantMarker.on('mouseover', function(){
          try { restaurantMarker.setPopupHtml && restaurantMarker.setPopupHtml(popupHtml); restaurantMarker.openPopup && restaurantMarker.openPopup(); } catch(e){}
        });
        restaurantMarker.on('mouseout', function(){
          try { restaurantMarker.closePopup && restaurantMarker.closePopup(); } catch(e){}
        });
      }
    } catch(e) { console.error('marker hover setup failed', e); }
    currentRestaurantMarkerId = Number(restaurant_id);
    // on drag end, send new coords
    try {
      restaurantMarker.on('dragend', function(ev){
        try{
          const p = (typeof restaurantMarker.getPosition === 'function') ? restaurantMarker.getPosition() : (ev?.latlng ?? ev?.target?.getPosition?.());
          let plat = p?.lat ?? (Array.isArray(p) ? p[0] : null);
          let plng = p?.lng ?? (Array.isArray(p) ? p[1] : null);
          if (plat == null && Array.isArray(p)) { plat = p[0]; plng = p[1]; }
          if (plat != null && plng != null) sendRestaurantLocation(currentRestaurantMarkerId, Number(plat), Number(plng));
        }catch(e){ console.error('dragend handler error', e); }
      });
    } catch (e) {}
    if (send) sendRestaurantLocation(restaurant_id, Number(lat), Number(lng));
  } catch (err) { console.error('placeRestaurantMarker', err); }
}


socket.on("agentLocation", (data) => {
  const { agent_id, lat, lng, order_id, orderId } = data || {};
  const id = agent_id ?? data?.agentId ?? null;
  if (id == null) return;
  const orderNum = order_id ?? orderId ?? data?.orderNum ?? data?.order_id;
  const label = orderNum ? `Agent #${id} ‚Äî Order #${orderNum}` : `Agent #${id}`;
  ensureInitMapAndMarker(id, lat, lng, label);
});

socket.on("locationUpdate", (data) => {
  const { agentId, lat, lng, order_id, orderId } = data || {};
  const id = agentId ?? data?.agent_id ?? null;
  if (id == null) return;
  const orderNum = order_id ?? orderId ?? data?.orderNum ?? data?.order_id;
  const label = orderNum ? `Agent #${id} ‚Äî Order #${orderNum}` : `Agent #${id}`;
  ensureInitMapAndMarker(id, lat, lng, label);
});

// Re-fetch list and markers when filter changes
document.addEventListener('change', (e) => {
  if (e.target && e.target.id === 'agentFilter') {
    loadDeliveryBoys();
  }
});

// ===== Active Orders =====
async function loadActiveOrders() {
  console.log("üì¶ Loading active orders...");
  
  const res = await apiCall("/api/admin/orders");
  if (!res.success) {
    showToast(`Failed to load orders: ${res.error}`, false);
    return;
  }

  renderActiveOrders(res.data || []);
  console.log(`‚úÖ Loaded ${res.data?.length || 0} active orders`);
}

function renderActiveOrders(orders) {
  const list = document.getElementById("activeOrders");
  
  if (!orders.length) {
    list.innerHTML = `<p class="text-gray-500">No active orders</p>`;
    return;
  }

  list.innerHTML = orders.map(o => {
    let itemsText = "N/A";
    try {
      if (typeof o.items === "string") {
        const parsed = JSON.parse(o.items);
        itemsText = Array.isArray(parsed) ? parsed.map(i => i.name || i.item_name).join(", ") : o.items;
      }
    } catch (_) {
      itemsText = o.items || "N/A";
    }

    return `
      <div class="card bg-green-50 p-4 rounded-xl shadow">
        <div class="flex justify-between items-start mb-3">
          <div>
            <p class="font-bold">Order #${o.id}</p>
            <p class="text-sm text-gray-600">Items: ${itemsText}</p>
          </div>
          <span class="px-2 py-1 text-xs font-semibold rounded ${getStatusColor(o.status)}">${o.status || "Unknown"}</span>
        </div>
        <p class="text-sm text-gray-600 mb-3">Delivery to: ${o.delivery_address || "N/A"}</p>
        <button onclick="assignAgent(${o.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
          ü§ñ Auto-Assign Agent
        </button>
      </div>
    `;
  }).join("");
}

function getStatusColor(status) {
  const statusMap = {
    "pending": "bg-yellow-100 text-yellow-800",
    "confirmed": "bg-blue-100 text-blue-800",
    "preparing": "bg-purple-100 text-purple-800",
    "ready": "bg-indigo-100 text-indigo-800",
    "picked_up": "bg-cyan-100 text-cyan-800",
    "delivered": "bg-green-100 text-green-800",
    "cancelled": "bg-red-100 text-red-800"
  };
  return statusMap[status?.toLowerCase()] || "bg-gray-100 text-gray-800";
}

async function assignAgent(orderId) {
  try {
    console.log(`ü§ñ Auto-assigning agent to order ${orderId}...`);
    
    const res = await apiCall(`/api/admin/orders/${orderId}/assign`, {
      method: "POST"
    });

    if (res.success) {
      showToast(`‚úÖ Agent assigned to order #${orderId}`);
      await loadActiveOrders();
      await loadStats();
    } else {
      showToast(`Failed to assign: ${res.error}`, false);
    }
  } catch (err) {
    console.error("Assign error:", err);
    showToast(`Error: ${err.message}`, false);
  }
}

// ===== Notifications =====
socket.on("newOrder", (order) => {
  const noti = document.createElement("li");
  noti.className = "bg-green-100 p-3 rounded shadow";
  noti.textContent = `üì¶ New Order #${order.id} placed by ${order.customer_name || "Customer"}`;
  document.getElementById("notifications").prepend(noti);
  console.log("üîî New order notification:", order);
  loadActiveOrders();
  loadStats();
});

// ===== Logout =====
function logout() {
  console.log("üëã User logging out...");
  localStorage.removeItem("user");
  localStorage.removeItem("token");
  window.location.href = "login.html";
}

// ===== Init On Page Load =====
document.addEventListener("DOMContentLoaded", async () => {
  console.log("üöÄ Admin Dashboard Initializing...");
  
  try {
    // Load all data in parallel
    console.log("üì• Loading dashboard data...");
    await Promise.all([
      loadStats(),
      loadPendingRestaurants(),
      loadPendingAgents(),
      loadAllMenu(),
      loadDeliveryBoys(),
      loadActiveOrders(),
      loadFeaturedRestaurants(),
      loadTopRestaurants(),
      loadBanners(),
      loadRestaurantsForMap()
    ]);
    
    console.log("‚úÖ Dashboard ready!");
    showToast("Dashboard loaded successfully");
  } catch (err) {
    console.error("‚ùå Dashboard initialization error:", err);
    showToast("Error loading dashboard", false);
  }
});

// Initialize Charts (demo data)
setTimeout(() => {
  try {
    const ordersCanvas = document.getElementById("ordersChart");
    const revenueCanvas = document.getElementById("revenueChart");
    
    if (ordersCanvas) {
      new Chart(ordersCanvas, {
        type: "bar",
        data: {
          labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
          datasets: [{
            label: "Orders",
            data: [40, 55, 30, 60, 70, 90, 50],
            backgroundColor: "rgba(34,197,94,0.6)",
            borderColor: "rgba(34,197,94,1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }
    
    if (revenueCanvas) {
      new Chart(revenueCanvas, {
        type: "line",
        data: {
          labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
          datasets: [{
            label: "Revenue",
            data: [20000, 25000, 18000, 30000, 40000, 35000],
            borderColor: "rgba(34,197,94,1)",
            backgroundColor: "rgba(34,197,94,0.2)",
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }
    
    console.log("üìä Charts initialized");
  } catch (err) {
    console.warn("‚ö†Ô∏è Chart initialization skipped:", err.message);
  }
});

// Listen to pending agent filter changes
document.addEventListener("change", (e) => {
  if (e.target && e.target.id === "pendingAgentFilter") {
    loadPendingAgents();
  }
});
</script>
<script>
// ===== Banners Form Submission =====
const bannerForm = document.getElementById("bannerForm");
if (bannerForm) {
  bannerForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const file = document.getElementById("bannerFile").files[0];
    if (!file) {
      showToast("Select an image", false);
      return;
    }

    const fd = new FormData();
    fd.append("banner", file);

    try {
      console.log("üì§ Uploading banner...");
      const res = await fetch(`${BASE}/api/admin/banners`, {
        method: "POST",
        headers: token ? { Authorization: `Bearer ${token}` } : {},
        body: fd
      });

      const result = await res.json();
      if (res.ok) {
        showToast("‚úÖ Banner uploaded");
        bannerForm.reset();
        await loadBanners();
      } else {
        showToast(`Failed: ${result.error || "Upload failed"}`, false);
      }
    } catch (err) {
      showToast(`Error: ${err.message}`, false);
      console.error("Banner upload error:", err);
    }
  });
}

async function removeBanner(id) {
  if (!confirm("Remove this banner?")) return;

  try {
    console.log(`üóëÔ∏è Removing banner ${id}...`);
    const res = await fetch(`${BASE}/api/admin/banners/${id}`, {
      method: "DELETE",
      headers: token ? { Authorization: `Bearer ${token}` } : {}
    });

    const result = await res.json();
    if (res.ok) {
      showToast("‚úÖ Banner removed");
      await loadBanners();
    } else {
      showToast(`Failed: ${result.error || "Delete failed"}`, false);
    }
  } catch (err) {
    showToast(`Error: ${err.message}`, false);
    console.error("Banner removal error:", err);
  }
}
</script>

<script>
// ===== Fullscreen Map + Route Drawing (Admin) =====
async function loadRestaurantsForMap() {
  try {
    console.log("üó∫Ô∏è Loading restaurants for map...");
    const res = await apiCall("/api/admin/all-restaurants");
    if (!res.success) {
      console.warn("Restaurants load failed for map");
      return;
    }

    // Handle both array responses and {data: []} responses
    let arr = [];
    if (Array.isArray(res.data)) {
      arr = res.data;
    } else if (res.data && Array.isArray(res.data.data)) {
      arr = res.data.data;
    } else if (Array.isArray(res)) {
      arr = res;
    }
    restaurantsById = new Map(arr.map(r => [Number(r.id), r]));

    // Setup restaurant ID input
    const input = document.getElementById("restaurantIdInput");
    if (input) {
      input.value = "";
      input.addEventListener("change", (e) => {
        const id = Number(e.target.value);
        clearRestaurantMarker();
        if (!id) return;

        const r = restaurantsById.get(id);
        const rlat = r?.latitude ?? r?.lat;
        const rlng = r?.longitude ?? r?.lng;

        if (r && Number.isFinite(Number(rlat)) && Number.isFinite(Number(rlng))) {
          placeRestaurantMarker(id, Number(rlat), Number(rlng), false);
          try {
            if (map) {
              map.setCenter([Number(rlat), Number(rlng)]);
              map.setZoom(15);
            }
          } catch (_) {}
        } else {
          showToast("Click on the map to set location", false);
        }
      });

      const clearBtn = document.getElementById("btnClearRestaurantMarker");
      if (clearBtn) {
        clearBtn.addEventListener("click", () => {
          clearRestaurantMarker();
          input.value = "";
        });
      }
    }

    // Load saved restaurant markers
    try {
      const savedRes = await apiCall("/api/get-restaurants");
      const saved = savedRes.success ? savedRes.data : arr;

      restaurantSavedMarkers.forEach(m => {
        try {
          if (m && typeof m.remove === "function") m.remove();
        } catch (_) {}
      });
      restaurantSavedMarkers = [];

      try {
        initAdminMap();
      } catch (_) {}

      if (typeof map !== "undefined" && map && Array.isArray(saved)) {
        saved.forEach(r => {
          const lat = r.latitude ?? r.lat;
          const lng = r.longitude ?? r.lng;

          if (lat != null && lng != null && Number.isFinite(Number(lat)) && Number.isFinite(Number(lng))) {
            try {
              const popupHtml = `<b>${r.name} (#${r.id})</b>`;
              const mk = new mappls.Marker({
                map,
                position: [Number(lat), Number(lng)],
                popupHtml
              });

              if (mk && typeof mk.on === "function") {
                mk.on("click", function() {
                  const inp = document.getElementById("restaurantIdInput");
                  if (inp) {
                    inp.value = r.id;
                    inp.focus();
                  }
                  try {
                    clearRestaurantMarker();
                    placeRestaurantMarker(r.id, Number(lat), Number(lng), false);
                  } catch (_) {}
                });

                mk.on("mouseover", function() {
                  try {
                    if (mk.setPopupHtml) mk.setPopupHtml(popupHtml);
                    if (mk.openPopup) mk.openPopup();
                  } catch (_) {}
                });

                mk.on("mouseout", function() {
                  try {
                    if (mk.closePopup) mk.closePopup();
                  } catch (_) {}
                });
              }

              restaurantSavedMarkers.push(mk);
            } catch (e) {
              console.error("Failed to add restaurant marker:", e);
            }
          }
        });
      }
    } catch (err) {
      console.warn("Could not load saved restaurant markers:", err);
    }

    console.log(`‚úÖ Map loaded with ${restaurantSavedMarkers.length} restaurant markers`);
  } catch (err) {
    console.error("Load restaurants for map error:", err);
  }
}

async function loadAllUsersLight() {
  try {
    console.log("üë§ Loading users for map...");
    const res = await apiCall("/api/admin/users");
    if (!res.success) {
      console.warn("Users load failed");
      return;
    }

    const arr = res.data || [];
    usersById = new Map(arr.map(u => [Number(u.id), u]));
    console.log(`‚úÖ Loaded ${arr.length} users`);
  } catch (err) {
    console.error("Load users error:", err);
  }
}

// Open fullscreen map
document.addEventListener("DOMContentLoaded", () => {
  const btnFullMapAdmin = document.getElementById("btnFullMapAdmin");
  if (btnFullMapAdmin) {
    btnFullMapAdmin.addEventListener("click", async () => {
      try {
        const res = await apiCall("/api/admin/orders");
        const orders = res.success ? res.data : [];
        const withAgent = orders.filter(o => o.agent_id);
        const order = withAgent[0] || orders[0] || null;
        openAdminFullMap(order);
      } catch (e) {
        openAdminFullMap(null);
      }
    });
  }
});

function openAdminFullMap(order) {
  const modal = document.getElementById("adminFullMapModal");
  const closeBtn = document.getElementById("adminFullMapClose");

  modal.classList.remove("hidden");
  modal.classList.add("flex");

  if (!adminFullMap) {
    if (typeof mappls === "undefined") {
      console.error("Mappls SDK not loaded");
    } else {
      adminFullMap = new mappls.Map("adminFullMap", {
        center: [17.385, 78.486],
        zoom: 12
      });
    }
  }

  drawAdminRoute(order);

  closeBtn.onclick = () => {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  };

  modal.addEventListener("click", (e) => {
    if (e.target === modal) closeBtn.click();
  });
}

function clearAdminRoute() {
  adminFullMapLayers.forEach(l => {
    try {
      if (typeof l.setMap === "function") l.setMap(null);
      else if (typeof l.remove === "function") l.remove();
    } catch (_) {}
  });
  adminFullMapLayers = [];
}

async function getMapplsToken() {
  try {
    const res = await apiCall("/api/mappls/token");
    if (!res.success) throw new Error("Token request failed");
    return res.data?.access_token || res.data?.token || null;
  } catch (e) {
    console.warn("Failed to get Mappls token:", e.message);
    return null;
  }
}

async function drawAdminRoute(order) {
  clearAdminRoute();

  const infoOrder = document.getElementById("adminInfoOrder");
  const infoRest = document.getElementById("adminInfoRestaurant");
  const infoPhone = document.getElementById("adminInfoPhone");

  if (!order) {
    if (infoOrder) infoOrder.textContent = "‚Äî";
    if (infoRest) infoRest.textContent = "‚Äî";
    if (infoPhone) infoPhone.textContent = "‚Äî";
    return;
  }

  if (infoOrder) infoOrder.textContent = `#${order.id}`;

  const rest = restaurantsById.get(Number(order.restaurant_id));
  if (infoRest) infoRest.textContent = rest ? rest.name : String(order.restaurant_id || "Unknown");

  const user = usersById.get(Number(order.user_id));
  if (infoPhone) infoPhone.textContent = user?.phone || "‚Äî";

  // Coordinates
  const rlat = Number(rest?.lat || rest?.latitude);
  const rlng = Number(rest?.lng || rest?.longitude);
  const ulat = Number(order.delivery_lat);
  const ulng = Number(order.delivery_lng);

  let alat, alng;
  if (order.agent_id && deliveryMarkers[order.agent_id]) {
    const mk = deliveryMarkers[order.agent_id];
    try {
      const p =
        typeof mk.getPosition === "function"
          ? mk.getPosition()
          : typeof mk.getLatLng === "function"
          ? mk.getLatLng()
          : null;

      if (Array.isArray(p)) {
        alat = p[0];
        alng = p[1];
      } else if (p && typeof p.lat !== "undefined") {
        alat = p.lat;
        alng = p.lng;
      }
    } catch (_) {}
  }

  const points = [];
  const markers = [];

  function addMarker(lat, lng, label) {
    if (Number.isFinite(lat) && Number.isFinite(lng)) {
      try {
        const m = new mappls.Marker({
          map: adminFullMap,
          position: [lat, lng],
          popupHtml: label
        });
        adminFullMapLayers.push(m);
        markers.push(m);
        points.push([lat, lng]);
      } catch (e) {
        console.error("Add marker failed:", e);
      }
    }
  }

  if (Number.isFinite(alat) && Number.isFinite(alng))
    addMarker(alat, alng, `Agent #${order.agent_id}`);
  if (Number.isFinite(rlat) && Number.isFinite(rlng))
    addMarker(rlat, rlng, `Restaurant ${rest?.name || ""}`);
  if (Number.isFinite(ulat) && Number.isFinite(ulng))
    addMarker(ulat, ulng, `User ${user?.phone || ""}`);

  // Draw route or straight lines
  const aPt = Number.isFinite(alat) && Number.isFinite(alng) ? [alat, alng] : null;
  const rPt = Number.isFinite(rlat) && Number.isFinite(rlng) ? [rlat, rlng] : null;
  const uPt = Number.isFinite(ulat) && Number.isFinite(ulng) ? [ulat, ulng] : null;

  let routeDrawn = false;

  try {
    const token = await getMapplsToken();
    const seq = [aPt, rPt, uPt].filter(Boolean);

    if (seq.length >= 2) {
      const parts = seq.map(p => `${p[1]},${p[0]}`).join(";");
      const url = `https://apis.mappls.com/advancedmaps/v1/route_adv/driving/${parts}?geometries=geojson${token ? `&access_token=${encodeURIComponent(token)}` : ""}`;

      const res = await fetch(url);
      if (res.ok) {
        const data = await res.json();
        const coords = data?.routes?.[0]?.geometry?.coordinates?.map(c => [c[1], c[0]]) || null;

        if (coords) {
          const pl = new mappls.Polyline({
            map: adminFullMap,
            path: coords,
            strokeColor: "#16a34a",
            strokeWeight: 6,
            strokeOpacity: 1
          });

          adminFullMapLayers.push(pl);
          routeDrawn = true;

          const lats = coords.map(p => p[0]);
          const lngs = coords.map(p => p[1]);
          const minLat = Math.min(...lats);
          const maxLat = Math.max(...lats);
          const minLng = Math.min(...lngs);
          const maxLng = Math.max(...lngs);

          try {
            adminFullMap.fitBounds([[minLat, minLng], [maxLat, maxLng]]);
          } catch (_) {}
        }
      }
    }
  } catch (_) {}

  if (!routeDrawn) {
    const straight = [aPt, rPt, uPt].filter(Boolean);

    for (let i = 0; i < straight.length - 1; i++) {
      try {
        const seg = new mappls.Polyline({
          map: adminFullMap,
          path: [straight[i], straight[i + 1]],
          strokeColor: "#10b981",
          strokeOpacity: 0.9,
          strokeWeight: 5
        });

        adminFullMapLayers.push(seg);
      } catch (e) {
        console.error("Add segment failed:", e);
      }
    }

    if (points.length) {
      const lats = points.map(p => p[0]);
      const lngs = points.map(p => p[1]);
      const minLat = Math.min(...lats);
      const maxLat = Math.max(...lats);
      const minLng = Math.min(...lngs);
      const maxLng = Math.max(...lngs);

      try {
        adminFullMap.fitBounds([[minLat, minLng], [maxLat, maxLng]]);
      } catch (_) {}
    }
  }
}
</script>
</body>
</html>
